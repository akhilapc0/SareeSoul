<!DOCTYPE html>
<html lang="en">
<head>
  <%- include('./partials/head') %>
  <title>Edit Personal Info</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body class="bg-light">
  <%- include('./partials/header') %>

  <div class="container mt-4 mb-5">
    <div class="row">
      <div class="col-md-8 offset-md-2">
        <div class="card shadow border-0">
          <div class="card-header bg-primary text-white py-3">
            <h5 class="mb-0"><i class="fas fa-user-edit me-2"></i>Edit Personal Information</h5>
          </div>
          <div class="card-body">
            <form id="editPersonalForm" enctype="multipart/form-data">
              
              <!-- profile image -->
              <div class="mb-3">
                <label class="form-label fw-semibold">Profile Image</label>
                <input type="file" name="image" class="form-control" accept="image/*" onchange="previewImage(event)">
                <div class="mt-2">
                  <img id="preview" src="<%= user.image ? user.image : '/images/default-profile.png' %>" 
                       alt="Profile Preview"
                       class="rounded-circle border" width="70" height="70" style="object-fit: cover;">
                </div>
              </div>

              <!-- first name -->
              <div class="mb-3">
                <label class="form-label fw-semibold">First Name</label>
                <input type="text" name="firstName" value="<%= user.firstName %>" class="form-control">
                <div class="text-danger small" id="firstNameError"></div>
              </div>

              <!-- last name -->
              <div class="mb-3">
                <label class="form-label fw-semibold">Last Name</label>
                <input type="text" name="lastName" value="<%= user.lastName %>" class="form-control">
                <div class="text-danger small" id="lastNameError"></div>
              </div>

              <!-- phone -->
              <div class="mb-3">
                <label class="form-label fw-semibold">Phone</label>
                <input type="text" name="phoneNumber" value="<%= user.phoneNumber || '' %>" class="form-control">
                <div class="text-danger small" id="phoneError"></div>
              </div>

              <!-- buttons -->
              <div class="d-flex justify-content-between">
                <a href="/profile" class="btn btn-secondary">Cancel</a>
                <button type="submit" class="btn btn-primary">Save Changes</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <%- include('./partials/footer') %>

  <!-- Scripts - Load in correct order -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  
  <script>
  // Simple validation without Joi first - let's test if SweetAlert works
  document.getElementById("editPersonalForm").addEventListener("submit", async function(e) {
    e.preventDefault();

    const form = e.target;
    const formData = new FormData(form);

    // Clear errors
    document.getElementById("firstNameError").textContent = "";
    document.getElementById("lastNameError").textContent = "";
    document.getElementById("phoneError").textContent = "";

    // Simple validation
    const firstName = form.firstName.value.trim();
    const lastName = form.lastName.value.trim();
    const phoneNumber = form.phoneNumber.value.trim();

    let hasErrors = false;

    if (!firstName) {
      document.getElementById("firstNameError").textContent = "First name is required";
      hasErrors = true;
    }

    if (!lastName) {
      document.getElementById("lastNameError").textContent = "Last name is required";
      hasErrors = true;
    }

    if (!phoneNumber) {
      document.getElementById("phoneError").textContent = "Phone number is required";
      hasErrors = true;
    } else if (!/^[0-9]{10}$/.test(phoneNumber)) {
      document.getElementById("phoneError").textContent = "Phone must be 10 digits";
      hasErrors = true;
    }

    if (hasErrors) return;

    try {
      const res = await fetch("/profile/edit", {
        method: "POST",
        body: formData
      });

      const result = await res.json();

      if (result.success) {
        
        Swal.fire({
          icon: "success",
          title: "Success!",
          text: "Profile updated successfully!",
          timer: 2000,
          showConfirmButton: false
        }).then(() => {
          window.location.href = "/profile";
        });
      } else {
        if (result.errors) {
          if (result.errors.firstName) document.getElementById("firstNameError").textContent = result.errors.firstName;
          if (result.errors.lastName) document.getElementById("lastNameError").textContent = result.errors.lastName;
          if (result.errors.phoneNumber) document.getElementById("phoneError").textContent = result.errors.phoneNumber;
        } else {
          Swal.fire({
            icon: "error",
            title: "Error!",
            text: result.message || "Something went wrong"
          });
        }
      }

    } catch (err) {
      console.log("Error:", err);
      Swal.fire({
        icon: "error", 
        title: "Error!",
        text: "Could not connect to server"
      });
    }
  });

  function previewImage(event) {
    if (event.target.files && event.target.files[0]) {
      const reader = new FileReader();
      reader.onload = function() {
        document.getElementById('preview').src = reader.result;
      }
      reader.readAsDataURL(event.target.files[0]);
    }
  }
  </script>

</body>
</html>