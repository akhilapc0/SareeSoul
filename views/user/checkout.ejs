<%- include('partials/head') %>

  <style>
    :root {
      --primary-teal: #008B8B;
      --primary-teal-dark: #006B6B;
      --success-green: #28a745;
      --danger-red: #dc3545;
      --light-bg: #f8f9fa;
      --card-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    body {
      background-color: var(--light-bg);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .checkout-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 30px 15px;
    }

    .page-title {
      color: #333;
      font-size: 2rem;
      font-weight: 600;
      margin-bottom: 30px;
      padding-bottom: 15px;
      border-bottom: 3px solid var(--primary-teal);
    }

    /* Card Styles */
    .card {
      border: none;
      border-radius: 12px;
      box-shadow: var(--card-shadow);
      margin-bottom: 24px;
      background: white;
    }

    .card-header {
      background: linear-gradient(135deg, var(--primary-teal) 0%, var(--primary-teal-dark) 100%);
      color: white;
      border-radius: 12px 12px 0 0 !important;
      padding: 16px 20px;
      border: none;
    }

    .card-header h5 {
      margin: 0;
      font-weight: 600;
      font-size: 1.1rem;
    }

    .card-body {
      padding: 24px;
    }

    /* Address Cards */
    .address-card {
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      padding: 18px;
      transition: all 0.3s ease;
      cursor: pointer;
      background: white;
    }

    .address-card:hover {
      border-color: var(--primary-teal);
      box-shadow: 0 4px 12px rgba(0, 139, 139, 0.15);
      transform: translateY(-2px);
    }

    .form-check-input:checked~.form-check-label .address-card {
      border-color: var(--primary-teal);
      background: rgba(0, 139, 139, 0.05);
    }

    .address-card h6 {
      color: #333;
      font-weight: 600;
      margin-bottom: 10px;
    }

    .address-card p {
      color: #666;
      margin-bottom: 5px;
      font-size: 0.9rem;
    }

    /* Badges */
    .badge {
      padding: 5px 12px;
      border-radius: 20px;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .badge.bg-success {
      background-color: var(--success-green) !important;
    }

    /* Order Items */
    .order-item {
      padding: 16px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .order-item:last-child {
      border-bottom: none;
    }

    .order-item img {
      border-radius: 8px;
      border: 1px solid #e0e0e0;
    }

    .order-item h6 {
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }

    .order-item small {
      color: #888;
      font-size: 0.85rem;
    }

    .order-item .price {
      font-size: 1rem;
      color: #666;
    }

    .order-item .total-price {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--primary-teal);
    }

    /* Order Summary */
    .summary-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      color: #666;
    }

    .summary-row.discount {
      color: var(--success-green);
      font-weight: 600;
    }

    .summary-row.total {
      border-top: 2px solid #e0e0e0;
      padding-top: 16px;
      margin-top: 10px;
      font-size: 1.2rem;
      font-weight: 700;
      color: #333;
    }

    .summary-row.total .amount {
      color: var(--primary-teal);
    }

    /* Available Coupons Section */
    .coupons-section {
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      border-radius: 12px;
      padding: 20px;
      margin: 20px 0;
      border: 2px dashed var(--primary-teal);
    }

    .coupons-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: #333;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .coupon-item {
      background: white;
      border: 2px solid #e0e0e0;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 12px;
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .coupon-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 5px;
      height: 100%;
      background: var(--primary-teal);
      transition: width 0.3s ease;
    }

    .coupon-item:hover {
      border-color: var(--primary-teal);
      box-shadow: 0 4px 12px rgba(0, 139, 139, 0.2);
      transform: translateY(-2px);
    }

    .coupon-item:hover::before {
      width: 100%;
      opacity: 0.05;
    }

    .coupon-item.selected {
      border-color: var(--primary-teal);
      background: rgba(0, 139, 139, 0.05);
      box-shadow: 0 6px 16px rgba(0, 139, 139, 0.25);
    }

    .coupon-code {
      font-size: 1.3rem;
      font-weight: 700;
      color: var(--primary-teal);
      margin-bottom: 8px;
      letter-spacing: 1px;
    }

    .coupon-description {
      font-size: 0.95rem;
      color: #555;
      margin-bottom: 10px;
    }

    .coupon-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px;
    }

    .coupon-badge {
      display: inline-block;
      background: var(--primary-teal);
      color: white;
      padding: 4px 12px;
      border-radius: 15px;
      font-size: 0.8rem;
      font-weight: 600;
    }

    .coupon-validity {
      font-size: 0.8rem;
      color: #999;
      font-style: italic;
    }

    .btn-select-coupon {
      background: var(--primary-teal);
      color: white;
      border: none;
      padding: 10px 24px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 0.9rem;
    }

    .btn-select-coupon:hover {
      background: var(--primary-teal-dark);
      transform: scale(1.05);
    }

    .btn-remove-coupon {
      background: #dc3545;
      color: white;
      border: none;
      padding: 10px 24px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      width: 100%;
      margin-top: 10px;
    }

    .btn-remove-coupon:hover {
      background: #c82333;
    }

    .applied-coupon-display {
      background: linear-gradient(135deg, #28a745 0%, #20883b 100%);
      color: white;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
    }

    .applied-coupon-display h6 {
      margin: 0 0 5px 0;
      font-size: 1.2rem;
      font-weight: 700;
    }

    .applied-coupon-display p {
      margin: 0;
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .savings-badge {
      background: #ffc107;
      color: #333;
      padding: 10px 15px;
      border-radius: 8px;
      font-weight: 700;
      text-align: center;
      margin-top: 10px;
      font-size: 1.1rem;
    }

    .no-coupons-alert {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 8px;
      padding: 15px;
      text-align: center;
      color: #856404;
    }

    /* Payment Methods */
    .payment-method {
      padding: 14px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      margin-bottom: 12px;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .payment-method:hover {
      border-color: var(--primary-teal);
      background: rgba(0, 139, 139, 0.03);
    }

    .form-check-input:checked~.payment-method {
      border-color: var(--primary-teal);
      background: rgba(0, 139, 139, 0.08);
    }

    /* Buttons */
    .btn-primary {
      background: linear-gradient(135deg, var(--primary-teal) 0%, var(--primary-teal-dark) 100%);
      border: none;
      padding: 14px 30px;
      font-weight: 600;
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(0, 139, 139, 0.3);
    }

    .btn-outline-secondary {
      border: 2px solid #ddd;
      color: #666;
      padding: 12px 30px;
      font-weight: 600;
      border-radius: 8px;
      transition: all 0.3s ease;
    }

    .btn-outline-secondary:hover {
      background: #f5f5f5;
      border-color: #bbb;
      color: #333;
    }

    /* Alerts */
    .alert-warning {
      background: #fff3cd;
      border: 1px solid #ffc107;
      border-radius: 8px;
      padding: 20px;
    }

    /* Sticky Summary */
    .sticky-summary {
      position: sticky;
      top: 20px;
    }

    /* Responsive */
    @media (max-width: 768px) {
      .page-title {
        font-size: 1.5rem;
      }

      .sticky-summary {
        position: relative;
        top: 0;
      }

      .coupon-item {
        padding: 12px;
      }

      .coupon-code {
        font-size: 1.1rem;
      }
    }
  </style>

  <body>
    <%- include('partials/header') %>
      <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

      <div class="checkout-container">
        <h2 class="page-title">Checkout</h2>

        <!-- Flash Error Message -->
        <% if (error_msg && error_msg.length> 0) { %>
          <script>
            Swal.fire({
              icon: 'error',
              title: 'Oops...',
              text: "<%= error_msg[0] %>",
              confirmButtonColor: '#008B8B'
            });
          </script>
          <% } %>

            <form id="checkoutForm" method="POST" action="/checkout/place-order">
              <div class="row">
                <!-- Left Column: Address & Items -->
                <div class="col-lg-8">

                  <!-- Delivery Address Section -->
                  <div class="card">
                    <div class="card-header">
                      <h5>üè† Delivery Address</h5>
                    </div>
                    <div class="card-body">
                      <% if (addresses.length===0) { %>
                        <div class="alert alert-warning">
                          <p class="mb-2"><strong>No delivery address found</strong></p>
                          <p class="mb-3">Please add a delivery address to proceed with your order.</p>
                          <a href="/add-address" class="btn btn-sm btn-primary">+ Add New Address</a>
                        </div>
                        <% } else { %>
                          <div class="row">
                            <% addresses.forEach(address=> { %>
                              <div class="col-md-6 mb-3">
                                <div class="form-check">
                                  <input class="form-check-input" type="radio" name="addressId"
                                    id="address<%= address._id %>" value="<%= address._id %>" <%=address.isDefault
                                    ? 'checked' : '' %>
                                  required
                                  >
                                  <label class="form-check-label w-100" for="address<%= address._id %>">
                                    <div class="address-card">
                                      <h6>
                                        <%= address.name %>
                                      </h6>
                                      <p>
                                        <%= address.addressLine1 %>
                                      </p>
                                      <% if (address.addressLine2) { %>
                                        <p>
                                          <%= address.addressLine2 %>
                                        </p>
                                        <% } %>
                                          <p>
                                            <%= address.city %>, <%= address.state %> - <%= address.pincode %>
                                          </p>
                                          <p>üìû <%= address.mobile %>
                                          </p>
                                          <% if (address.isDefault) { %>
                                            <span class="badge bg-success">Default</span>
                                            <% } %>
                                    </div>
                                  </label>
                                </div>
                              </div>
                              <% }) %>
                          </div>
                          <a href="/add-address" class="btn btn-sm btn-outline-primary mt-2">+ Add New Address</a>
                          <% } %>
                    </div>
                  </div>

                  <!-- Order Items Section -->
                  <div class="card">
                    <div class="card-header">
                      <h5>üõçÔ∏è Order Items</h5>
                    </div>
                    <div class="card-body">
                      <% items.forEach(item=> { %>
                        <div class="order-item row align-items-center">
                          <div class="col-3 col-md-2">
                            <img
                              src="<%= item.variantId.images && item.variantId.images[0] ? item.variantId.images[0] : '/images/placeholder.jpg' %>"
                              alt="<%= item.productId.name %>" class="img-fluid">
                          </div>
                          <div class="col-5 col-md-5">
                            <h6>
                              <%= item.productId.name %>
                            </h6>
                            <small>Color: <%= item.variantId.colour %></small><br>
                            <small>Quantity: <%= item.quantity %></small>
                          </div>
                          <div class="col-2 col-md-3 text-center">
                            <p class="price mb-0">‚Çπ<%= item.productId.salesPrice %>
                            </p>
                          </div>
                          <div class="col-2 text-end">
                            <p class="total-price mb-0">
                              ‚Çπ<%= (item.quantity * item.productId.salesPrice).toFixed(2) %>
                            </p>
                          </div>
                        </div>
                        <% }) %>
                    </div>
                  </div>

                </div>

                <!-- Right Column: Order Summary -->
                <div class="col-lg-4">
                  <div class="card sticky-summary">
                    <div class="card-header">
                      <h5>üí≥ Order Summary</h5>
                    </div>
                    <div class="card-body">

                      <!-- Subtotal & Shipping -->
                      <div class="summary-row">
                        <span>Subtotal:</span>
                        <span id="subtotalDisplay">‚Çπ<%= subtotal.toFixed(2) %></span>
                      </div>
                      <div class="summary-row">
                        <span>Shipping:</span>
                        <span class="text-success fw-bold">FREE</span>
                      </div>

                      <!-- Discount Row (Hidden by default) -->
                      <div class="summary-row discount" id="discountRow" style="display: none;">
                        <span>Discount (<span id="appliedCouponCode"></span>):</span>
                        <span id="discountDisplay">-‚Çπ0.00</span>
                      </div>

                      <!-- Available Coupons Section -->
                      <% if (typeof availableCoupons !=='undefined' && availableCoupons && availableCoupons.length> 0) {
                        %>
                        <div class="coupons-section">
                          <div class="coupons-title">
                            üéÅ Available Coupons
                          </div>

                          <!-- Applied Coupon Display (Hidden by default) -->
                          <div id="appliedCouponDisplay" style="display: none;">
                            <div class="applied-coupon-display">
                              <h6>‚úÖ Coupon Applied</h6>
                              <p><strong id="currentCouponCode"></strong></p>
                            </div>
                            <button type="button" class="btn-remove-coupon" onclick="removeCoupon()">
                              Remove Coupon
                            </button>
                          </div>

                          <!-- Coupon List -->
                          <div id="couponList">
                            <% availableCoupons.forEach(coupon=> { %>
                              <div class="coupon-item" data-coupon="<%= coupon.code %>">
                                <div class="d-flex justify-content-between align-items-start">
                                  <div style="flex: 1;">
                                    <div class="coupon-code">
                                      <%= coupon.code %>
                                    </div>
                                    <div class="coupon-description">
                                      Get <%= coupon.discountValue %>% off on your order
                                    </div>
                                    <div class="coupon-tags">
                                      <span class="coupon-badge">
                                        <%= coupon.discountValue %>% OFF
                                      </span>
                                      <span class="coupon-badge">Max ‚Çπ<%= coupon.maxDiscount %></span>
                                      <% if (coupon.minCartAmount> 0) { %>
                                        <span class="coupon-badge">Min ‚Çπ<%= coupon.minCartAmount %></span>
                                        <% } %>
                                    </div>
                                    <div class="coupon-validity">
                                      Valid till: <%= new Date(coupon.validityDate).toLocaleDateString('en-IN', {
                                        day: '2-digit' , month: 'short' , year: 'numeric' }) %>
                                    </div>
                                  </div>
                                  <button type="button" class="btn-select-coupon"
                                    onclick="applyCoupon('<%= coupon.code %>')">
                                    Apply
                                  </button>
                                </div>
                              </div>
                              <% }) %>
                          </div>

                          <!-- Savings Display (Hidden by default) -->
                          <div id="savingsDisplay" class="savings-badge" style="display: none;">
                            üí∞ You saved ‚Çπ<span id="savingsAmount">0</span>!
                          </div>
                        </div>
                        <% } else { %>
                          <div class="no-coupons-alert">
                            <small>üì¶ No coupons available for this order</small>
                          </div>
                          <% } %>

                            <!-- Payment Method -->
                            <div class="mt-3 mb-3">
                              <label class="form-label fw-bold" style="color: #333;">Payment Method</label>

                              <div class="form-check">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="cod" value="COD"
                                  checked>
                                <label class="form-check-label w-100" for="cod">
                                  <div class="payment-method">
                                    <strong>üíµ Cash on Delivery</strong>
                                    <small class="d-block text-muted">Pay when you receive</small>
                                  </div>
                                </label>
                              </div>

                              <div class="form-check">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="razorpay"
                                  value="Razorpay">
                                <label class="form-check-label w-100" for="razorpay">
                                  <div class="payment-method">
                                    <strong>üí≥ Online Payment</strong>
                                    <small class="d-block text-muted">Pay via Razorpay</small>
                                  </div>
                                </label>
                              </div>

                              <div class="form-check">
                                <input class="form-check-input" type="radio" name="paymentMethod" id="wallet"
                                  value="Wallet">
                                <label class="form-check-label w-100" for="wallet">
                                  <div class="payment-method">
                                    <strong>üëõ Pay Using Wallet</strong>
                                    <small class="d-block text-muted">
                                      Available Balance: ‚Çπ<%= walletBalance %>
                                    </small>
                                  </div>
                                </label>
                              </div>





                            </div>

                            <!-- Total -->
                            <div class="summary-row total">
                              <span>Total:</span>
                              <span class="amount" id="totalDisplay">‚Çπ<%= subtotal.toFixed(2) %></span>
                            </div>

                            <!-- Action Buttons -->
                            <button type="submit" class="btn btn-primary w-100 mt-3" <%=addresses.length===0
                              ? 'disabled' : '' %>
                              >
                              Place Order ‚Üí
                            </button>
                            <a href="/cart" class="btn btn-outline-secondary w-100 mt-2">‚Üê Back to Cart</a>

                    </div>
                  </div>
                </div>

              </div>
            </form>
      </div>

      <%- include('partials/footer') %>

        <!-- Razorpay SDK -->
        <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

        <script>
          const subtotalValue = <%= subtotal.toFixed(2) %>;
          let currentDiscount = 0;
          let currentCouponCode = '';

          // Apply Coupon Function
          async function applyCoupon(couponCode) {
            try {
              const response = await fetch('/coupon/apply', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  couponCode,
                  subtotal: subtotalValue
                })
              });

              const data = await response.json();

              if (data.success) {
                currentDiscount = data.discount;
                currentCouponCode = couponCode;

                // Update UI
                document.getElementById('discountRow').style.display = 'flex';
                document.getElementById('appliedCouponCode').textContent = couponCode;
                document.getElementById('discountDisplay').textContent = `-‚Çπ${data.discount.toFixed(2)}`;
                document.getElementById('totalDisplay').textContent = `‚Çπ${data.total.toFixed(2)}`;

                // Show savings
                document.getElementById('savingsDisplay').style.display = 'block';
                document.getElementById('savingsAmount').textContent = data.discount.toFixed(2);

                // Hide coupon list, show applied coupon
                document.getElementById('couponList').style.display = 'none';
                document.getElementById('appliedCouponDisplay').style.display = 'block';
                document.getElementById('currentCouponCode').textContent = couponCode;

                Swal.fire({
                  icon: 'success',
                  title: 'Coupon Applied!',
                  text: data.message,
                  confirmButtonColor: '#008B8B',
                  timer: 2000,
                  showConfirmButton: false
                });
              } else {
                Swal.fire({
                  icon: 'error',
                  title: 'Cannot Apply Coupon',
                  text: data.message,
                  confirmButtonColor: '#008B8B'
                });
              }
            } catch (error) {
              console.error('Error applying coupon:', error);
              Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Failed to apply coupon. Please try again.',
                confirmButtonColor: '#008B8B'
              });
            }
          }

          // Remove Coupon Function
          async function removeCoupon() {
            try {
              const response = await fetch('/coupon/remove', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ subtotal: subtotalValue })
              });

              const data = await response.json();

              if (data.success) {
                currentDiscount = 0;
                currentCouponCode = '';

                // Update UI
                document.getElementById('discountRow').style.display = 'none';
                document.getElementById('discountDisplay').textContent = '-‚Çπ0.00';
                document.getElementById('totalDisplay').textContent = `‚Çπ${subtotalValue.toFixed(2)}`;

                // Hide savings
                document.getElementById('savingsDisplay').style.display = 'none';

                // Show coupon list again
                document.getElementById('couponList').style.display = 'block';
                document.getElementById('appliedCouponDisplay').style.display = 'none';

                Swal.fire({
                  icon: 'success',
                  title: 'Coupon Removed',
                  text: data.message,
                  confirmButtonColor: '#008B8B',
                  timer: 1500,
                  showConfirmButton: false
                });
              }
            } catch (error) {
              console.error('Error removing coupon:', error);
              Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Failed to remove coupon. Please try again.',
                confirmButtonColor: '#008B8B'
              });
            }
          }

          // Razorpay Payment Handler
          const form = document.getElementById('checkoutForm');

          form.addEventListener('submit', async function (e) {
            e.preventDefault();

            const paymentMethod = form.paymentMethod.value;
            const addressId = form.addressId.value;

            // Handle COD directly
            if (paymentMethod === 'COD') {
              form.submit();
              return;
            }

            
            // Handle Wallet Payment
if (paymentMethod === 'Wallet') {
  try {
    const totalAmount = parseFloat(document.getElementById('totalDisplay').textContent.replace('‚Çπ',''));

    const response = await fetch('/checkout/place-order', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ addressId, paymentMethod:'Wallet' })
    });

    const data = await response.json();

    if (data.success) {
      Swal.fire({
        icon: 'success',
        title: 'Order Placed!',
        text: 'Payment done using Wallet.',
        confirmButtonColor: '#008B8B',
        timer:2000,
        showConfirmButton:false
      }).then(() => {
        window.location.href = data.redirectUrl;
      });
    } else {
      Swal.fire({
        icon: 'error',
        title: 'Failed',
        text: data.message || 'Insufficient wallet balance.',
        confirmButtonColor: '#008B8B'
      });
    }
  } catch (error) {
    console.error('Wallet payment error:',error);
    Swal.fire({
      icon: 'error',
      title: 'Error',
      text: 'Something went wrong with wallet payment.',
      confirmButtonColor: '#008B8B'
    });
  }
  
  return;
}








            // Handle Razorpay
            try {
              const response = await fetch('/checkout/place-order', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ addressId, paymentMethod })
              });

              const data = await response.json();

              if (!data.success) {
                Swal.fire({
                  icon: 'error',
                  title: 'Error',
                  text: 'Something went wrong. Please try again.',
                  confirmButtonColor: '#008B8B'
                });
                return;
              }

              const options = {
                key: data.key,
                amount: data.amount,
                currency: 'INR',
                name: 'Saree Store',
                description: 'Order Payment',
                order_id: data.razorpayOrderId,
                handler: async function (response) {
                  try {
                    const verifyRes = await fetch('/checkout/verify-payment', {
                      method: 'POST',
                      headers: { 'Content-Type': 'application/json' },
                      body: JSON.stringify({
                        razorpay_order_id: response.razorpay_order_id,
                        razorpay_payment_id: response.razorpay_payment_id,
                        razorpay_signature: response.razorpay_signature,
                        orderId: data.orderId,
                        addressId
                      })
                    });

                    if (!verifyRes.ok) {
                      throw new Error(`HTTP error! status: ${verifyRes.status}`);
                    }

                    const verifyData = await verifyRes.json();

                    if (verifyData.success) {
                      window.location.href = verifyData.redirectUrl;
                    } else {
                      window.location.href = '/payment-failed?orderId=' + data.orderId + '&reason=Verification failed';
                    }
                  } catch (error) {
                    console.error('Error in payment handler:', error);
                    window.location.href = '/payment-failed?orderId=' + data.orderId + '&reason=Processing error';
                  }
                },
                modal: {
                  ondismiss: function () {
                    window.location.href = '/payment-failed?orderId=' + data.orderId + '&reason=Payment cancelled by user';
                  }
                },
                prefill: {
                  name: '<%= user.firstName %>',
                  email: '<%= user.email %>'
                },
                theme: { color: '#008B8B' }
              };

              const rzp = new Razorpay(options);
              rzp.open();

            } catch (err) {
              console.error('Outer error:', err);
              Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Something went wrong. Please try again.',
                confirmButtonColor: '#008B8B'
              });
            }
          });
        </script>

  </body>

  </html>