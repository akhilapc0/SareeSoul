<!DOCTYPE html>
<html lang="en">

<head>
  <%- include('./partials/head') %>
    <title>Shop - Saree Soul</title>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
      /* Offer Badge Styling */
      .offer-badge {
        position: absolute;
        top: 10px;
        right: 10px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 5px 12px;
        border-radius: 20px;
        font-size: .85rem;
        font-weight: bold;
        z-index: 10;
        box-shadow: 0 2px 8px rgba(0, 0, 0, .2);
      }

      .product-price {
        margin-top: 10px;
      }

      .offer-price {
        color: #28a745;
        font-size: 1.3rem;
        font-weight: bold;
      }

      .original-price {
        text-decoration: line-through;
        color: #999;
        font-size: 1rem;
        margin-left: 8px;
      }

      .card {
        position: relative;
        transition: transform .3s ease, box-shadow .3s ease;
      }

      .card:hover {
        transform: translateY(-5px);
        box-shadow: 0 5px 20px rgba(0, 0, 0, .15);
      }

      .card-img-top {
        height: 300px;
        object-fit: cover;
        cursor: pointer;
      }

      .clear-filters-btn {
        display: inline-flex;
        align-items: center;
        gap: 5px;
      }
    </style>
</head>

<body>
  <%- include('./partials/header') %>

    <div class="container mt-4">

      <!-- Search + Filter Form -->
      <form method="GET" action="/shop" class="row g-3 mb-4" id="filterForm">
        <div class="col-md-3">
          <input type="text" name="search" id="searchInput" class="form-control" placeholder="Search products..." value="<%= search %>">
        </div>

        <div class="col-md-2">
          <select name="category" id="categorySelect" class="form-select">
            <option value="">All Categories</option>
            <% categories.forEach(cat=> { %>
              <option value="<%= cat.name %>" <%=category===cat.name?'selected':'' %>><%= cat.name %>
              </option>
              <% }) %>
          </select>
        </div>

        <div class="col-md-2">
          <select name="brand" id="brandSelect" class="form-select">
            <option value="">All Brands</option>
            <% brands.forEach(br=> { %>
              <option value="<%= br.name %>" <%=brand===br.name?'selected':'' %>><%= br.name %>
              </option>
              <% }) %>
          </select>
        </div>

        <div class="col-md-2 d-flex">
          <input type="number" name="minPrice" id="minPrice" class="form-control" placeholder="Min" value="<%= minPrice %>">
          <input type="number" name="maxPrice" id="maxPrice" class="form-control ms-1" placeholder="Max" value="<%= maxPrice %>">
        </div>

        <div class="col-md-2">
          <select name="sort" id="sortSelect" class="form-select">
            <option value="">Default</option>
            <option value="priceLowHigh" <%=sortOption==='priceLowHigh' ?'selected':'' %>>Price: Low to High</option>
            <option value="priceHighLow" <%=sortOption==='priceHighLow' ?'selected':'' %>>Price: High to Low</option>
            <option value="aToZ" <%=sortOption==='aToZ' ?'selected':'' %>>A to Z</option>
            <option value="zToA" <%=sortOption==='zToA' ?'selected':'' %>>Z to A</option>
            <option value="newArrivals" <%=sortOption==='newArrivals' ?'selected':'' %>>New Arrivals</option>
          </select>
        </div>

        <div class="col-md-1">
          <button type="submit" class="btn btn-primary w-100">Go</button>
        </div>
      </form>

      <!-- Clear Filters Button (only shows when filters are active) -->
      <% if (search || category || brand || minPrice || maxPrice || sortOption) { %>
        <div class="mb-3">
          <button type="button" class="btn btn-outline-secondary clear-filters-btn" onclick="clearAllFilters()">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-x-circle" viewBox="0 0 16 16">
              <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
              <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
            </svg>
            Clear All Filters
          </button>
        </div>
      <% } %>

      <!-- Products Grid -->
      <div class="row">
        <% if (products.length===0) { %>
          <div class="col-12 text-center">
            <p class="text-muted">No products found.</p>
          </div>
          <% } else { %>
            <% products.forEach(product=> { %>
              <div class="col-md-3 mb-4">
                <div class="card h-100">

                  <!-- Offer Badge -->
                  <% if (product.hasOffer) { %>
                    <span class="offer-badge">
                      <%= product.discount %>% OFF
                    </span>
                    <% } %>

                      <!-- Clickable Image → Product Detail -->
                      <a href="/product/<%= product._id %>">
                        <img src="<%= product.image %>" class="card-img-top" alt="<%= product.name %>">
                      </a>

                      <div class="card-body d-flex flex-column">
                        <h5 class="card-title">
                          <%= product.name %>
                        </h5>

                        <p class="text-muted mb-2"><small>
                            <%= product.categoryId?.name || 'Category' %>
                          </small></p>

                        <!-- Price -->
                        <div class="product-price">
                          <% if (product.hasOffer) { %>
                            <span class="offer-price">₹<%= product.offerPrice %></span>
                            <span class="original-price">₹<%= product.salesPrice %></span>
                            <% } else { %>
                              <span class="offer-price">₹<%= product.salesPrice %></span>
                              <% } %>
                        </div>

                        <!-- ADD TO CART BUTTON -->
                        <button class="btn btn-success w-100 mt-3 add-to-cart" data-productid="<%= product._id %>"
                          data-variantid="<%= product.variantId %>">
                          Add to Cart
                        </button>
                      </div>
                </div>
              </div>
              <% }) %>
                <% } %>
      </div>

      <!-- Pagination -->
      <% if (totalPages> 1) { %>
        <nav aria-label="Page navigation">
          <ul class="pagination justify-content-center">
            <% for (let i=1; i<=totalPages; i++) { %>
              <li class="page-item <%= i===currentPage?'active':'' %>">
                <a class="page-link"
                  href="?page=<%= i %>&search=<%= search %>&category=<%= category %>&brand=<%= brand %>&minPrice=<%= minPrice %>&maxPrice=<%= maxPrice %>&sort=<%= sortOption %>">
                  <%= i %>
                </a>
              </li>
              <% } %>
          </ul>
        </nav>
        <% } %>

    </div>

    <%- include('./partials/footer') %>

    <!-- Clear Filters Function -->
    <script>
      function clearAllFilters() {
        document.getElementById('searchInput').value = '';
        document.getElementById('categorySelect').value = '';
        document.getElementById('brandSelect').value = '';
        document.getElementById('minPrice').value = '';
        document.getElementById('maxPrice').value = '';
        document.getElementById('sortSelect').value = '';
        
        // Submit the form to reload with cleared filters
        document.getElementById('filterForm').submit();
      }
    </script>

    <!-- Add to Cart Script -->
    <script>
      document.querySelectorAll('.add-to-cart').forEach(button => {
        button.addEventListener('click', async (e) => {
          const productId = e.target.getAttribute('data-productid');
          const variantId = e.target.getAttribute('data-variantid');

          try {
            const res = await fetch('/cart', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ productId, variantId, quantity: 1 })
            });

            const data = await res.json();

            if (res.ok) {
              Swal.fire({
                icon: 'success',
                title: 'Added to Cart!',
                text: data.message || 'Product successfully added.',
                showCancelButton: true,
                confirmButtonText: 'Go to Cart',
                cancelButtonText: 'Continue Shopping',
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#aaa'
              }).then((result) => {
                if (result.isConfirmed) {
                  window.location.href = '/cart';
                }
              });
            } else {
              Swal.fire({
                icon: 'error',
                title: 'Error',
                text: data.message || 'Something went wrong.'
              });
            }
          } catch (err) {
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: 'Failed to add to cart. Please try again.'
            });
          }
        });
      });
    </script>

</body>

</html>