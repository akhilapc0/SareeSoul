<!DOCTYPE html>
<html lang="en">

  <%- include('./partials/head') %>
   <!-- Google Places API -->
  <script src="https://maps.googleapis.com/maps/api/js?key=<%= process.env.GOOGLE_MAPS_API_KEY %>&libraries=places"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    :root {
      --primary-color: #1a365d;
      --primary-hover: #2a4a66;
      --accent-color: #3182ce;
      --accent-light: #63b3ed;
      --secondary-color: #718096;
      --success-color: #38a169;
      --danger-color: #e53e3e;
      --warning-color: #dd6b20;
      --light-bg: #f7fafc;
      --card-bg: #ffffff;
      --border-color: #e2e8f0;
      --text-primary: #2d3748;
      --text-secondary: #718096;
      --text-muted: #a0aec0;
      --shadow-sm: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      --radius-sm: 0.375rem;
      --radius-md: 0.5rem;
      --radius-lg: 0.75rem;
      --radius-xl: 1rem;
    }

    * {
      box-sizing: border-box;
    }

    body {
      background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
      font-family: 'Segoe UI', system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      color: var(--text-primary);
      line-height: 1.6;
      font-size: 16px;
      margin: 0;
      padding: 0;
      min-height: 100vh;
    }

    .content-main {
      padding: 3rem 1.5rem;
      max-width: 1200px;
      margin: 0 auto;
      min-height: calc(100vh - 200px);
    }

    .content-header {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--primary-hover) 50%, var(--accent-color) 100%);
      color: white;
      padding: 3rem 2.5rem;
      border-radius: var(--radius-xl);
      margin-bottom: 3rem;
      box-shadow: var(--shadow-xl);
      position: relative;
      overflow: hidden;
    }

    .content-header::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%23ffffff' fill-opacity='0.03'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
      pointer-events: none;
    }

    .content-header > * {
      position: relative;
      z-index: 1;
    }

    .content-header h2 {
      margin: 0 0 0.75rem 0;
      font-size: 2.5rem;
      font-weight: 700;
      letter-spacing: -0.02em;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .content-header p {
      margin: 0;
      opacity: 0.95;
      font-size: 1.125rem;
      font-weight: 400;
    }

    .btn-outline-secondary {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      color: white;
      padding: 0.875rem 1.75rem;
      border-radius: var(--radius-lg);
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-weight: 600;
      font-size: 0.95rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .btn-outline-secondary:hover {
      background: rgba(255, 255, 255, 0.25);
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      text-decoration: none;
    }

    .card {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-lg);
      overflow: hidden;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
    }

    .card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, var(--primary-color) 0%, var(--accent-color) 100%);
    }

    .card:hover {
      box-shadow: var(--shadow-xl);
      transform: translateY(-2px);
    }

    .card-header {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
      border-bottom: 2px solid var(--border-color);
      padding: 2rem 2.5rem;
      position: relative;
    }

    .card-title {
      margin: 0 0 0.5rem 0;
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--text-primary);
      letter-spacing: -0.01em;
    }

    .card-header small {
      color: var(--text-secondary);
      font-size: 1rem;
      font-weight: 500;
    }

    .card-body {
      padding: 2.5rem;
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
    }

    .form-floating {
      position: relative;
      margin-bottom: 0.75rem;
    }

    .form-control {
      border: 2px solid var(--border-color);
      border-radius: var(--radius-lg);
      padding: 1.25rem 1.25rem 1.25rem 1.25rem;
      font-size: 1.05rem;
      font-weight: 500;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      height: auto;
      line-height: 1.5;
      box-shadow: var(--shadow-sm);
    }

    .form-control::placeholder {
      color: transparent;
    }

    .form-control:focus {
      border-color: var(--accent-color);
      box-shadow: 0 0 0 4px rgba(49, 130, 206, 0.1);
      outline: none;
      background: white;
      transform: translateY(-1px);
    }

    .form-control:not(:placeholder-shown) {
      border-color: var(--success-color);
      background: white;
    }

    .form-control.is-invalid {
      border-color: var(--danger-color);
      background: #fff5f5;
    }

    .form-floating label {
      color: var(--text-secondary);
      font-weight: 600;
      font-size: 0.95rem;
      padding: 0.5rem 1rem;
      background: linear-gradient(135deg, #ffffff 0%, #f8fafc 100%);
      border-radius: var(--radius-sm);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      margin: 0 0.5rem;
    }

    .form-control:focus ~ label,
    .form-control:not(:placeholder-shown) ~ label {
      color: var(--accent-color);
      font-weight: 700;
      font-size: 0.875rem;
      background: white;
      box-shadow: var(--shadow-sm);
    }

    .text-danger {
      color: var(--danger-color);
      font-size: 0.9rem;
      margin-top: 0.5rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem;
      background: linear-gradient(135deg, #fed7d7 0%, #feb2b2 100%);
      border-radius: var(--radius-md);
      border-left: 4px solid var(--danger-color);
      box-shadow: var(--shadow-sm);
    }

    .text-danger::before {
      content: "‚ö†";
      font-size: 1rem;
      color: var(--danger-color);
    }

    .mb-4 {
      margin-bottom: 2rem;
    }

    hr {
      border: none;
      height: 2px;
      background: linear-gradient(90deg, transparent, var(--border-color), transparent);
      margin: 3rem 0;
      border-radius: var(--radius-sm);
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--primary-color) 0%, var(--accent-color) 100%);
      border: none;
      color: white;
      padding: 1rem 2.5rem;
      border-radius: var(--radius-lg);
      font-weight: 700;
      font-size: 1.05rem;
      display: inline-flex;
      align-items: center;
      gap: 0.75rem;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: var(--shadow-md);
      position: relative;
      overflow: hidden;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .btn-primary::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
      transition: left 0.5s;
    }

    .btn-primary:hover::before {
      left: 100%;
    }

    .btn-primary:hover {
      transform: translateY(-3px);
      box-shadow: var(--shadow-xl);
      background: linear-gradient(135deg, var(--primary-hover) 0%, var(--accent-light) 100%);
    }

    .btn-primary:active {
      transform: translateY(-1px);
    }

    .btn-primary:disabled {
      opacity: 0.7;
      cursor: not-allowed;
      transform: none;
      box-shadow: var(--shadow-sm);
    }

    .material-icons {
      font-size: 1.25rem;
    }

    .d-flex {
      display: flex;
    }

    .justify-content-between {
      justify-content: space-between;
    }

    .align-items-center {
      align-items: center;
    }

    .row {
      margin: 0 -1rem;
    }

    .col-lg-8 {
      padding: 0 1rem;
      max-width: 100%;
    }

    @media (min-width: 992px) {
      .col-lg-8 {
        max-width: 75%;
      }
      
      .content-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 3.5rem 3rem;
      }

      .card-body {
        padding: 3rem;
      }

      .card-header {
        padding: 2.5rem 3rem;
      }
    }

    
    @keyframes shimmer {
      0% { background-position: -200px 0; }
      100% { background-position: calc(200px + 100%) 0; }
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }

    .btn-primary:disabled {
      animation: pulse 2s infinite;
      background: linear-gradient(270deg, #e2e8f0, #cbd5e0, #e2e8f0);
      background-size: 200% 200%;
      animation: shimmer 2s infinite linear;
    }


    .form-control.is-valid {
      border-color: var(--success-color);
      box-shadow: 0 0 0 4px rgba(56, 161, 105, 0.1);
      background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%);
    }

    
    .form-control:focus-visible {
      outline: 2px solid var(--accent-color);
      outline-offset: 2px;
    }

    
    .btn:focus-visible,
    .btn-outline-secondary:focus-visible {
      outline: 2px solid white;
      outline-offset: 2px;
    }

    
    .content-main {
      animation: fadeInUp 0.6s ease-out;
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
      .pac-container {
      z-index: 10000;
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-xl);
      border: 2px solid var(--accent-color);
      margin-top: 8px;
    }

    .pac-item {
      padding: 12px 16px;
      cursor: pointer;
      border-bottom: 1px solid var(--border-color);
      transition: background 0.2s ease;
    }

    .pac-item:hover {
      background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
    }

    .verified-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      color: var(--success-color);
      font-size: 0.95rem;
      font-weight: 600;
      margin-top: 0.75rem;
      padding: 0.75rem 1rem;
      background: linear-gradient(135deg, #f0fff4 0%, #c6f6d5 100%);
      border-radius: var(--radius-md);
      border-left: 4px solid var(--success-color);
      box-shadow: var(--shadow-sm);
    }

    .search-hint {
      font-size: 0.9rem;
      color: var(--text-secondary);
      margin-top: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .search-icon {
      font-size: 1.2rem;
    }
  </style>

  
  <body>
    <div class="screen-overlay"></div>
    
    <main class="main-wrap">
      <%- include('./partials/header') %>
      <section class="content-main">
        <div class="content-header">
          <div>
            <h2 class="content-title card-title">Add New Address</h2>
            <p>Add a new delivery address (verified with Google Maps)</p>
          </div>
          <div>
            <a href="/my-address" class="btn btn-outline-secondary">
              <i class="material-icons md-arrow_back"></i> Back to Address List
            </a>
          </div>
        </div>

        <div class="card mb-4">
          <header class="card-header">
            <h4 class="card-title">Address Details</h4>
            <small class="text-muted">Start typing your address for smart suggestions</small>
          </header>

          <div class="card-body">
            <form id="addAddressForm">
              <div class="row">
                <div class="col-lg-8">
                  <div class="mb-4">
                    <div class="form-floating">
                      <input type="text" class="form-control" id="name" name="name" placeholder="Full Name" />
                      <label for="name">Full Name</label>
                    </div>
                    <div id="nameError" class="text-danger" style="display: none;"></div>
                  </div>

                  <div class="mb-4">
                    <div class="form-floating">
                      <input type="text" class="form-control" id="phone" name="phone" placeholder="Phone Number" />
                      <label for="phone">Phone Number</label>
                    </div>
                    <div id="phoneError" class="text-danger" style="display: none;"></div>
                  </div>

                  <!-- üîç GOOGLE PLACES SEARCH -->
                  <div class="mb-4">
                    <div class="form-floating">
                      <input 
                        type="text" 
                        class="form-control" 
                        id="addressSearch" 
                        placeholder="Search your address..." 
                        autocomplete="off"
                      />
                      <label for="addressSearch">üîç Search Your Address (Google)</label>
                    </div>
                    <div class="search-hint">
                      <span class="search-icon">üí°</span>
                      <span>Type your area, street, or landmark - Google will auto-fill the details below</span>
                    </div>
                    <div id="addressVerified" class="verified-badge" style="display: none;">
                      <i class="material-icons">check_circle</i>
                      Address verified with Google Maps
                    </div>
                  </div>

                  <div class="mb-4">
                    <div class="form-floating">
                      <input type="text" class="form-control" id="house" name="house" placeholder="House/Apartment Number" />
                      <label for="house">House/Apartment Number</label>
                    </div>
                    <div id="houseError" class="text-danger" style="display: none;"></div>
                  </div>

                  <div class="mb-4">
                    <div class="form-floating">
                      <input type="text" class="form-control" id="street" name="street" placeholder="Street Name" readonly />
                      <label for="street">Street Name (Auto-filled)</label>
                    </div>
                    <div id="streetError" class="text-danger" style="display: none;"></div>
                  </div>

                  <div class="mb-4">
                    <div class="form-floating">
                      <input type="text" class="form-control" id="city" name="city" placeholder="City" readonly />
                      <label for="city">City (Auto-filled)</label>
                    </div>
                    <div id="cityError" class="text-danger" style="display: none;"></div>
                  </div>

                  <div class="mb-4">
                    <div class="form-floating">
                      <input type="text" class="form-control" id="state" name="state" placeholder="State" readonly />
                      <label for="state">State (Auto-filled)</label>
                    </div>
                    <div id="stateError" class="text-danger" style="display: none;"></div>
                  </div>

                  <div class="mb-4">
                    <div class="form-floating">
                      <input type="text" class="form-control" id="pincode" name="pincode" placeholder="Pincode" readonly />
                      <label for="pincode">Pincode (Auto-filled)</label>
                    </div>
                    <div id="pincodeError" class="text-danger" style="display: none;"></div>
                  </div>
                </div>
              </div>

              <div id="backendError" class="text-danger mb-3" style="display: none;"></div>

              <hr class="my-4" />

              <div class="d-flex justify-content-between align-items-center">
                <div class="btn-group">
                  <button type="submit" id="submitBtn" class="btn btn-primary">
                    <i class="material-icons md-add"></i> Save Address
                  </button>
                </div>
              </div>
            </form>
          </div>
        </div>
      </section>
      <%- include('./partials/footer') %>
    </main>

    <script src="/admin/assets/js/vendors/jquery-3.6.0.min.js"></script>
    <script src="/admin/assets/js/bootstrap.bundle.min.js"></script>
    <script src="/admin/assets/js/main.js"></script>

    <script>
      // üåç GOOGLE PLACES AUTOCOMPLETE
      let autocomplete;
      let addressVerified = false;

      function initAutocomplete() {
        const input = document.getElementById('addressSearch');
        
        // Restrict to India only
        autocomplete = new google.maps.places.Autocomplete(input, {
          types: ['address'],
          componentRestrictions: { country: 'in' }
        });

        autocomplete.addListener('place_changed', fillInAddress);
      }

      function fillInAddress() {
        const place = autocomplete.getPlace();
        
        if (!place.geometry) {
          Swal.fire({
            icon: 'warning',
            title: 'Invalid Address',
            text: 'Please select a valid address from the suggestions',
            confirmButtonColor: '#3182ce'
          });
          return;
        }

        // Clear previous values
        document.getElementById('street').value = '';
        document.getElementById('city').value = '';
        document.getElementById('state').value = '';
        document.getElementById('pincode').value = '';

        let street = '';
        let city = '';
        let state = '';
        let pincode = '';

        // Parse address components
        for (const component of place.address_components) {
          const types = component.types;

          if (types.includes('street_number')) {
            street = component.long_name + ' ';
          }
          if (types.includes('route')) {
            street += component.long_name;
          }
          if (types.includes('sublocality_level_1') || types.includes('sublocality')) {
            if (!city) city = component.long_name;
          }
          if (types.includes('locality')) {
            city = component.long_name;
          }
          if (types.includes('administrative_area_level_1')) {
            state = component.long_name;
          }
          if (types.includes('postal_code')) {
            pincode = component.long_name;
          }
        }

        // Fill form fields
        document.getElementById('street').value = street || '';
        document.getElementById('city').value = city || '';
        document.getElementById('state').value = state || '';
        document.getElementById('pincode').value = pincode || '';

        // Mark as verified and valid
        if (street && city && state && pincode) {
          ['street', 'city', 'state', 'pincode'].forEach(field => {
            document.getElementById(field).classList.add('is-valid');
            document.getElementById(field).classList.remove('is-invalid');
          });
          
          document.getElementById('addressVerified').style.display = 'flex';
          addressVerified = true;

          Swal.fire({
            icon: 'success',
            title: 'Address Verified!',
            text: 'Google has verified your address details',
            timer: 2000,
            showConfirmButton: false
          });
        }
      }

      // Initialize on page load
      window.addEventListener('load', initAutocomplete);

      // Enhanced validation functions
      function showError(fieldId, message) {
        const errorDiv = document.getElementById(fieldId + 'Error');
        const input = document.getElementById(fieldId);
        errorDiv.textContent = message;
        errorDiv.style.display = 'flex';
        input.classList.add('is-invalid');
        input.classList.remove('is-valid');
      }

      function showSuccess(fieldId) {
        const errorDiv = document.getElementById(fieldId + 'Error');
        const input = document.getElementById(fieldId);
        errorDiv.style.display = 'none';
        input.classList.add('is-valid');
        input.classList.remove('is-invalid');
      }

      function clearError(fieldId) {
        const errorDiv = document.getElementById(fieldId + 'Error');
        const input = document.getElementById(fieldId);
        errorDiv.style.display = 'none';
        input.classList.remove('is-invalid', 'is-valid');
      }

      // Real-time validation for Name
      document.getElementById('name').addEventListener('input', function() {
        const value = this.value.trim();
        const nameRegex = /^[a-zA-Z\s'-]+$/;
        
        if (value.length === 0) {
          clearError('name');
        } else if (value.length < 2) {
          showError('name', 'Name must be at least 2 characters');
        } else if (value.length > 50) {
          showError('name', 'Name must be less than 50 characters');
        } else if (!nameRegex.test(value)) {
          showError('name', 'Name can only contain letters, spaces, hyphens, and apostrophes');
        } else {
          showSuccess('name');
        }
      });

      // Real-time validation for Phone
      document.getElementById('phone').addEventListener('input', function() {
        const value = this.value.trim();
        const phoneRegex = /^[0-9]{10}$/;
        
        if (value.length === 0) {
          clearError('phone');
        } else if (!phoneRegex.test(value)) {
          showError('phone', 'Phone must be exactly 10 digits');
        } else {
          showSuccess('phone');
        }
      });

      // Form submission
      document.getElementById("addAddressForm").addEventListener("submit", async function (e) {
        e.preventDefault();

        // Check if address is verified
        if (!addressVerified) {
          Swal.fire({
            icon: 'warning',
            title: 'Address Not Verified',
            text: 'Please select your address from Google suggestions first',
            confirmButtonColor: '#3182ce'
          });
          document.getElementById('addressSearch').focus();
          return;
        }

        // Clear all previous errors
        const errorFields = ['name', 'phone', 'house', 'street', 'city', 'state', 'pincode', 'backend'];
        errorFields.forEach(field => {
          const errorDiv = document.getElementById(field + 'Error');
          if (errorDiv) {
            errorDiv.style.display = 'none';
            errorDiv.textContent = '';
          }
        });

        const formData = {
          name: document.getElementById("name").value.trim(),
          phone: document.getElementById("phone").value.trim(),
          house: document.getElementById("house").value.trim(),
          street: document.getElementById("street").value.trim(),
          city: document.getElementById("city").value.trim(),
          state: document.getElementById("state").value.trim(),
          pincode: document.getElementById("pincode").value.trim(),
        };

        let isValid = true;

        // Validation
        const nameRegex = /^[a-zA-Z\s'-]+$/;
        const phoneRegex = /^[0-9]{10}$/;
        const pincodeRegex = /^[0-9]{6}$/;

        if (formData.name.length < 2 || !nameRegex.test(formData.name)) {
          showError('name', 'Please enter a valid name');
          isValid = false;
        }

        if (!phoneRegex.test(formData.phone)) {
          showError('phone', 'Phone must be exactly 10 digits');
          isValid = false;
        }

        if (formData.house.length < 1) {
          showError('house', 'House number is required');
          isValid = false;
        }

        if (!isValid) return;

        const submitBtn = document.getElementById("submitBtn");
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<i class="material-icons">hourglass_empty</i> Saving...';

        try {
          const res = await fetch("/add-address", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(formData),
          });

          const data = await res.json();

          if (!res.ok) {
            const backendError = document.getElementById("backendError");
            backendError.textContent = data.error || "Something went wrong";
            backendError.style.display = 'flex';
            return;
          }

          Swal.fire({
            icon: "success",
            title: "Success",
            text: "Address added successfully!",
            confirmButtonColor: "#3182ce"
          }).then(() => {
            window.location.href = "/my-address";
          });
        } catch (err) {
          console.error('Submit error:', err);
          const backendError = document.getElementById("backendError");
          backendError.textContent = "Network error. Please check your connection and try again.";
          backendError.style.display = 'flex';
        } finally {
          submitBtn.disabled = false;
          submitBtn.innerHTML = '<i class="material-icons md-add"></i> Save Address';
        }
      });
    </script>
  </body>
</html>