<%- include('partials/head') %>

  <style>
    :root {
      --primary-teal: #008B8B;
      --primary-teal-dark: #006B6B;
      --success-green: #28a745;
      --danger-red: #dc3545;
      --light-bg: #f8f9fa;
      --card-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    body {
      background-color: var(--light-bg);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    .wallet-container {
      max-width: 1000px;
      margin: 40px auto;
      padding: 20px;
    }

    .page-title {
      color: #333;
      font-size: 2rem;
      font-weight: 600;
      margin-bottom: 30px;
      padding-bottom: 15px;
      border-bottom: 3px solid var(--primary-teal);
    }

    .balance-card {
      background: linear-gradient(135deg, var(--primary-teal) 0%, var(--primary-teal-dark) 100%);
      border-radius: 16px;
      padding: 40px;
      color: white;
      box-shadow: 0 8px 24px rgba(0, 139, 139, 0.3);
      margin-bottom: 30px;
      position: relative;
      overflow: hidden;
    }

    .balance-card::before {
      content: '';
      position: absolute;
      top: -50%;
      right: -10%;
      width: 200px;
      height: 200px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
    }

    .balance-card::after {
      content: '';
      position: absolute;
      bottom: -30%;
      left: -5%;
      width: 150px;
      height: 150px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 50%;
    }

    .balance-content {
      position: relative;
      z-index: 1;
    }

    .balance-label {
      font-size: 1rem;
      opacity: 0.9;
      margin-bottom: 10px;
      font-weight: 500;
    }

    .balance-amount {
      font-size: 3rem;
      font-weight: 700;
      margin: 0;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .wallet-icon {
      width: 50px;
      height: 50px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .wallet-icon svg {
      width: 30px;
      height: 30px;
    }

    .transactions-card {
      background: white;
      border-radius: 16px;
      box-shadow: var(--card-shadow);
      overflow: hidden;
    }

    .transactions-header {
      background: linear-gradient(135deg, var(--primary-teal) 0%, var(--primary-teal-dark) 100%);
      color: white;
      padding: 20px 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .transactions-header h3 {
      margin: 0;
      font-size: 1.3rem;
      font-weight: 600;
    }

    .transaction-count {
      background: rgba(255, 255, 255, 0.2);
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
    }

    .transactions-body {
      padding: 25px;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .empty-state svg {
      width: 80px;
      height: 80px;
      color: #ddd;
      margin-bottom: 20px;
    }

    .empty-state h4 {
      color: #666;
      margin-bottom: 10px;
    }

    .empty-state p {
      color: #999;
      font-size: 0.95rem;
    }

    .transaction-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }

    .transaction-table thead th {
      background: #f8f9fa;
      padding: 15px;
      text-align: left;
      font-weight: 600;
      color: #555;
      font-size: 0.9rem;
      border-bottom: 2px solid #e0e0e0;
    }

    .transaction-table tbody tr {
      border-bottom: 1px solid #f0f0f0;
      transition: background 0.2s ease;
    }

    .transaction-table tbody tr:hover {
      background: #f8f9fa;
    }

    .transaction-table tbody td {
      padding: 18px 15px;
      color: #333;
    }

    .transaction-date {
      color: #666;
      font-size: 0.9rem;
    }

    .transaction-type {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 0.85rem;
      font-weight: 600;
    }

    .transaction-type.credit {
      background: #d4edda;
      color: #155724;
    }

    .transaction-type.debit {
      background: #f8d7da;
      color: #721c24;
    }

    .transaction-type svg {
      width: 14px;
      height: 14px;
    }

    .transaction-amount {
      font-weight: 700;
      font-size: 1.1rem;
    }

    .transaction-amount.credit {
      color: var(--success-green);
    }

    .transaction-amount.debit {
      color: var(--danger-red);
    }

    .transaction-reason {
      color: #666;
      font-size: 0.9rem;
    }

    /* Pagination Styles */
    .pagination-wrapper {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 25px;
      border-top: 1px solid #e0e0e0;
      background: #f8f9fa;
    }

    .pagination-info {
      color: #666;
      font-size: 0.9rem;
    }

    .pagination-controls {
      display: flex;
      gap: 0.5rem;
      align-items: center;
    }

    .pagination-btn {
      padding: 0.5rem 1rem;
      border: 1px solid #dee2e6;
      background: white;
      color: #495057;
      border-radius: 6px;
      font-weight: 500;
      text-decoration: none;
      transition: all 0.2s ease;
      font-size: 0.9rem;
    }

    .pagination-btn:hover:not(.disabled) {
      background: var(--primary-teal);
      color: white;
      border-color: var(--primary-teal);
    }

    .pagination-btn.disabled {
      opacity: 0.4;
      cursor: not-allowed;
      pointer-events: none;
    }

    .pagination-btn.active {
      background: var(--primary-teal);
      color: white;
      border-color: var(--primary-teal);
    }

    .page-numbers {
      display: flex;
      gap: 0.3rem;
    }

    .page-number {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid #dee2e6;
      background: white;
      color: #495057;
      border-radius: 6px;
      font-weight: 500;
      text-decoration: none;
      transition: all 0.2s ease;
      font-size: 0.9rem;
    }

    .page-number:hover {
      background: #f8f9fa;
      border-color: var(--primary-teal);
      color: var(--primary-teal);
    }

    .page-number.active {
      background: var(--primary-teal);
      color: white;
      border-color: var(--primary-teal);
    }

    @media (max-width: 768px) {
      .wallet-container {
        padding: 15px;
      }

      .page-title {
        font-size: 1.5rem;
      }

      .balance-card {
        padding: 30px 20px;
      }

      .balance-amount {
        font-size: 2rem;
      }

      .transaction-table {
        font-size: 0.85rem;
      }

      .transaction-table thead {
        display: none;
      }

      .transaction-table tbody tr {
        display: block;
        margin-bottom: 15px;
        border: 1px solid #e0e0e0;
        border-radius: 8px;
        padding: 15px;
      }

      .transaction-table tbody td {
        display: block;
        padding: 8px 0;
        border: none;
      }

      .transaction-table tbody td::before {
        content: attr(data-label);
        font-weight: 600;
        display: inline-block;
        width: 100px;
        color: #666;
      }

      .pagination-wrapper {
        flex-direction: column;
        gap: 1rem;
      }

      .page-numbers {
        flex-wrap: wrap;
        justify-content: center;
      }
    }
  </style>

  <body>
    <%- include('partials/header') %>

      <div class="wallet-container">
        <h2 class="page-title">üí∞ My Wallet</h2>

        <div class="balance-card">
          <div class="balance-content">
            <div class="balance-label">Available Balance</div>
            <div class="balance-amount">
              <div class="wallet-icon">
                <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
                  <path d="M1 3a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1H1zm7 8a2 2 0 1 0 0-4 2 2 0 0 0 0 4z" />
                  <path
                    d="M0 5a1 1 0 0 1 1-1h14a1 1 0 0 1 1 1v8a1 1 0 0 1-1 1H1a1 1 0 0 1-1-1V5zm3 0a2 2 0 0 1-2 2v4a2 2 0 0 1 2 2h10a2 2 0 0 1 2-2V7a2 2 0 0 1-2-2H3z" />
                </svg>
              </div>
              ‚Çπ<%= balance.toFixed(2) %>
            </div>
          </div>
        </div>

        <div style="text-align:right; margin-bottom:20px;">
          <button id="addMoneyBtn" class="btn btn-success">
            <i class="bi bi-plus-circle"></i> Add Money
          </button>
        </div>

        <div class="transactions-card">
          <div class="transactions-header">
            <h3>üìã Transaction History</h3>
            <% if (typeof totalTransactions !=='undefined' && totalTransactions> 0) { %>
              <span class="transaction-count">
                <%= totalTransactions %> Total
              </span>
              <% } %>
          </div>
          <div class="transactions-body">
            <% if (transactions && transactions.length> 0) { %>
              <table class="transaction-table">
                <thead>
                  <tr>
                    <th>Date & Time</th>
                    <th>Type</th>
                    <th>Amount</th>
                    <th>Reason</th>
                  </tr>
                </thead>
                <tbody>
                  <% transactions.forEach(transaction=> { %>
                    <tr>


                      <td data-label="Date">
                        <div class="transaction-date">
                          <%= new Date(transaction.createdAt).toLocaleString('en-IN', { day: '2-digit' , month: 'short'
                            , year: 'numeric' , hour: '2-digit' , minute: '2-digit' , hour12: true,
                            timeZone: 'Asia/Kolkata' }) %>
                        </div>
                      </td>


                      <td data-label="Type">
                        <span class="transaction-type <%= transaction.type.toLowerCase() %>">
                          <% if (transaction.type==='Credit' ) { %>
                            <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
                              <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z" />
                              <path
                                d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z" />
                            </svg>
                            <% } else { %>
                              <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z" />
                                <path d="M4 8a.5.5 0 0 1 .5-.5h7a.5.5 0 0 1 0 1h-7A.5.5 0 0 1 4 8z" />
                              </svg>
                              <% } %>
                                <%= transaction.type %>
                        </span>
                      </td>
                      <td data-label="Amount">
                        <div class="transaction-amount <%= transaction.type.toLowerCase() %>">
                          <%= transaction.type==='Credit' ? '+' : '-' %>‚Çπ<%= transaction.amount.toFixed(2) %>
                        </div>
                      </td>
                      <td data-label="Reason">
                        <div class="transaction-reason">
                          <%= transaction.reason %>
                        </div>
                      </td>
                    </tr>
                    <% }) %>
                </tbody>
              </table>

              <!-- Pagination -->
              <% if (typeof totalPages !=='undefined' && totalPages> 1) { %>
                <div class="pagination-wrapper">
                  <div class="pagination-info">
                    Showing <%= ((currentPage - 1) * 10) + 1 %>-<%= Math.min(currentPage * 10, totalTransactions) %> of
                        <%= totalTransactions %> transactions
                  </div>

                  <div class="pagination-controls">
                    <a href="/wallet?page=<%= currentPage - 1 %>"
                      class="pagination-btn <%= !hasPrevPage ? 'disabled' : '' %>">
                      ‚Üê Previous
                    </a>

                    <div class="page-numbers">
                      <% for (let i=1; i <=totalPages; i++) { %>
                        <% if (i===1 || i===totalPages || (i>= currentPage - 2 && i <= currentPage + 2)) { %>
                            <a href="/wallet?page=<%= i %>"
                              class="page-number <%= i === currentPage ? 'active' : '' %>">
                              <%= i %>
                            </a>
                            <% } else if (i===currentPage - 3 || i===currentPage + 3) { %>
                              <span class="page-number disabled">...</span>
                              <% } %>
                                <% } %>
                    </div>

                    <a href="/wallet?page=<%= currentPage + 1 %>"
                      class="pagination-btn <%= !hasNextPage ? 'disabled' : '' %>">
                      Next ‚Üí
                    </a>
                  </div>
                </div>
                <% } %>

                  <% } else { %>
                    <div class="empty-state">
                      <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16">
                        <path
                          d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z" />
                      </svg>
                      <h4>No Transactions Yet</h4>
                      <p>Your wallet transaction history will appear here</p>
                    </div>
                    <% } %>
          </div>
        </div>
      </div>

      <% if (typeof error !=='undefined' && error) { %>
        <script>
          Swal.fire({
            icon: 'error',
            title: 'Oops...',
            text: '<%= error %>',
            confirmButtonColor: '#008B8B'
          });
        </script>
        <% } %>

          <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
          <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

          <script>
            const razorpayKeyId = '<%= razorpayKeyId %>';

            document.getElementById('addMoneyBtn').addEventListener('click', async () => {
              const { value: amount } = await Swal.fire({
                title: 'Add Money to Wallet',
                html: `
          <input type="number" id="wallet-amount" class="swal2-input" 
                 placeholder="Enter amount (‚Çπ)" 
                 min="1" 
                 max="100000" 
                 step="1">
          <p style="font-size: 0.85rem; color: #666; margin-top: 10px;">
            Minimum: ‚Çπ1 | Maximum: ‚Çπ1,00,000
          </p>
        `,
                confirmButtonText: 'Proceed to Pay',
                confirmButtonColor: '#008B8B',
                showCancelButton: true,
                preConfirm: () => {
                  const value = document.getElementById('wallet-amount').value;
                  const num = parseFloat(value);

                  if (!value || isNaN(num)) {
                    Swal.showValidationMessage('Please enter a valid amount');
                    return false;
                  }
                  if (num < 1) {
                    Swal.showValidationMessage('Minimum amount is ‚Çπ1');
                    return false;
                  }
                  if (num > 100000) {
                    Swal.showValidationMessage('Maximum amount is ‚Çπ1,00,000');
                    return false;
                  }
                  return num;
                }
              });

              if (amount) {
                try {
                  Swal.fire({
                    title: 'Creating Payment Order...',
                    allowOutsideClick: false,
                    didOpen: () => {
                      Swal.showLoading();
                    }
                  });

                  const orderRes = await fetch('/wallet/create-order', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ amount })
                  });

                  const orderData = await orderRes.json();
                  console.log('Order created:', orderData);

                  if (!orderData.success) {
                    throw new Error(orderData.message || 'Failed to create order');
                  }

                  Swal.close();

                  const options = {
                    key: razorpayKeyId,
                    amount: orderData.amount * 100,
                    currency: orderData.currency,
                    name: 'Saree Soul',
                    description: 'Add Money to Wallet',
                    order_id: orderData.orderId,
                    prefill: {
                      name: orderData.user.name,
                      email: orderData.user.email,
                      contact: orderData.user.phone || ''
                    },
                    theme: {
                      color: '#008B8B'
                    },
                    handler: async function (response) {
                      Swal.fire({
                        title: 'Verifying Payment...',
                        allowOutsideClick: false,
                        didOpen: () => {
                          Swal.showLoading();
                        }
                      });

                      try {
                        const verifyRes = await fetch('/wallet/verify-payment', {
                          method: 'POST',
                          headers: { 'Content-Type': 'application/json' },
                          body: JSON.stringify({
                            razorpay_order_id: response.razorpay_order_id,
                            razorpay_payment_id: response.razorpay_payment_id,
                            razorpay_signature: response.razorpay_signature,
                            amount: orderData.amount
                          })
                        });

                        const verifyData = await verifyRes.json();

                        if (verifyData.success) {
                          await Swal.fire({
                            icon: 'success',
                            title: 'Success!',
                            text: `‚Çπ${amount} added to your wallet successfully!`,
                            confirmButtonColor: '#008B8B'
                          });
                          location.reload();
                        } else {
                          throw new Error(verifyData.message || 'Payment verification failed');
                        }
                      } catch (error) {
                        console.error('Verification error:', error);
                        Swal.fire({
                          icon: 'error',
                          title: 'Verification Failed',
                          text: error.message || 'Failed to verify payment. Please contact support.',
                          confirmButtonColor: '#008B8B'
                        });
                      }
                    },
                    modal: {
                      ondismiss: function () {
                        Swal.fire({
                          icon: 'info',
                          title: 'Payment Cancelled',
                          text: 'You cancelled the payment',
                          confirmButtonColor: '#008B8B'
                        });
                      }
                    }
                  };

                  const razorpay = new Razorpay(options);
                  razorpay.open();

                  razorpay.on('payment.failed', function (response) {
                    Swal.fire({
                      icon: 'error',
                      title: 'Payment Failed',
                      html: `
                <p><strong>Error:</strong> ${response.error.description}</p>
                <p style="font-size: 0.85rem; color: #666;">
                  Reason: ${response.error.reason}
                </p>
              `,
                      confirmButtonColor: '#008B8B'
                    });
                  });

                } catch (error) {
                  console.error('Error:', error);
                  Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: error.message || 'Something went wrong. Please try again.',
                    confirmButtonColor: '#008B8B'
                  });
                }
              }
            });
          </script>

          <%- include('partials/footer') %>
  </body>

  </html>