<!DOCTYPE html>
<html lang="en">
<%- include('./partials/head') %>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<style>
  .form-floating label { color: #6c757d; }
  .form-control:focus {
    border-color: #0d6efd;
    box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
  }
  .btn-group .btn { min-width: 120px; }
  .card { border: none; box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075); }
  .content-header { border-bottom: 1px solid #e3e6f0; padding-bottom: 1rem; margin-bottom: 1.5rem; }
  .text-danger { color: red; font-size: 14px; margin-top: 5px; }

  .img-thumb {
    width: 100px; height: 100px;
    object-fit: cover; border: 1px solid #ccc;
    border-radius: 5px; margin-right: 10px; position: relative;
  }
  .remove-btn {
    position: absolute; top: -5px; right: -5px;
    background: red; color: white; border: none;
    border-radius: 50%; width: 20px; height: 20px;
    cursor: pointer;
  }
</style>

<body>
  <%- include('./partials/sidebar') %>
  <main class="main-wrap">
    <%- include('./partials/header') %>

    <section class="content-main">
      <div class="content-header">
        <div>
          <h2 class="content-title card-title">Edit Variant</h2>
          <p>Editing variant of <strong><%= product.name %></strong></p>
        </div>
        <div>
          <a href="/admin/products/<%= product._id %>/variants" class="btn btn-outline-secondary">
            <i class="material-icons md-arrow_back"></i> Back to Variants
          </a>
        </div>
      </div>

      <div class="card mb-4">
        <header class="card-header">
          <h4 class="card-title">Variant Information</h4>
          <small class="text-muted">Update the fields below</small>
        </header>

        <div class="card-body">
          <form id="editVariantForm" enctype="multipart/form-data">
            <div class="row">
              <div class="col-lg-8">

                <!-- Colour -->
                <div class="mb-4">
                  <div class="form-floating">
                    <input type="text" class="form-control" id="colour" name="colour" 
                           value="<%= variant.colour %>" />
                    <label for="colour">Colour</label>
                  </div>
                  <div id="colourError" class="text-danger"></div>
                </div>

                <!-- Stock -->
                <div class="mb-4">
                  <div class="form-floating">
                    <input type="number" class="form-control" id="stock" name="stock" 
                           value="<%= variant.stock %>" />
                    <label for="stock">Stock</label>
                  </div>
                  <div id="stockError" class="text-danger"></div>
                </div>

                <!-- Existing Images -->
                <div class="mb-4">
                  <label class="form-label">Existing Images</label>
                  <div id="existingImagesPreview" style="display:flex; gap:10px; flex-wrap:wrap;">
                    <% variant.images.forEach((img, index) => { %>
                      <div style="position:relative;">
                        <img src="<%= img %>" class="img-thumb" />
                        <!-- hidden input for kept image -->
                        <input type="hidden" name="existingImages" value="<%= img %>" />
                        <button type="button" class="remove-btn" onclick="removeExisting(this)">Ã—</button>
                      </div>
                    <% }) %>
                  </div>
                </div>

                <!-- Upload New Images -->
                <div class="mb-4">
                  <label for="images" class="form-label">Upload New Images (Max 5 total)</label>
                  <input type="file" class="form-control" id="images" name="images" multiple />
                  <div id="imagesError" class="text-danger"></div>
                  <div id="newImagePreview" style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;"></div>
                </div>
              </div>
            </div>

            <div id="backendError" class="text-danger mb-3"></div>

            <hr class="my-4">
            <div class="d-flex justify-content-between align-items-center">
              <div class="btn-group">
                <button type="submit" id="submitBtn" class="btn btn-primary">
                  <i class="material-icons md-save"></i> Update Variant
                </button>
              </div>
            </div>
          </form>
        </div>
      </div>
    </section>
    <%- include('./partials/footer') %>
  </main>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const MAX_IMAGES = 5;
    let newFiles = [];

    // Remove existing image (UI + hidden input)
    function removeExisting(btn) {
      const wrapper = btn.parentElement;
      wrapper.remove();
    }

    // New image previews
    const imagesInput = document.getElementById("images");
    const newPreview = document.getElementById("newImagePreview");

    imagesInput.addEventListener("change", () => {
      newPreview.innerHTML = "";
      newFiles = Array.from(imagesInput.files);

      newFiles.forEach(file => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const div = document.createElement("div");
          div.style.position = "relative";

          const img = document.createElement("img");
          img.src = e.target.result;
          img.className = "img-thumb";

          div.appendChild(img);
          newPreview.appendChild(div);
        };
        reader.readAsDataURL(file);
      });
    });

    // Submit handler
    document.getElementById("editVariantForm").addEventListener("submit", async (e) => {
      e.preventDefault();

      const colour = document.getElementById("colour").value.trim();
      const stock = document.getElementById("stock").value.trim();
      const keptImages = Array.from(document.querySelectorAll("input[name='existingImages']"))
                              .map(input => input.value);

      document.getElementById("colourError").textContent = "";
      document.getElementById("stockError").textContent = "";
      document.getElementById("imagesError").textContent = "";
      document.getElementById("backendError").textContent = "";

      // Validate
      let totalCount = keptImages.length + newFiles.length;
      if (totalCount === 0) {
        document.getElementById("imagesError").textContent = "At least one image is required";
        return;
      }
      if (totalCount > MAX_IMAGES) {
        document.getElementById("imagesError").textContent = `Max ${MAX_IMAGES} images allowed`;
        return;
      }

      const formData = new FormData();
      formData.append("colour", colour);
      formData.append("stock", stock);
      keptImages.forEach(url => formData.append("existingImages", url));
      newFiles.forEach(file => formData.append("images", file));


    //   /products/:productId/variants/edit/:variantId
      try {
        const res = await fetch("/admin/products/<%= product._id %>/variants/edit/<%= variant._id %>", {
          method: "POST",
          body: formData
        });
        const data = await res.json();

        if (!res.ok) {
          document.getElementById("backendError").textContent = data.message || "Something went wrong";
          return;
        }

        Swal.fire({ icon: "success", title: "Updated!", text: data.message })
          .then(() => { window.location.href = "/admin/products/<%= product._id %>/variants"; });

      } catch (err) {
        document.getElementById("backendError").textContent = "Server error: " + err;
      }
    });
  </script>
</body>
</html>
