<!DOCTYPE html>
<html lang="en">
<%- include('./partials/head') %>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
  .search-input-wrapper {
    position: relative;
    width: 100%;
  }

  .search-clear-btn {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    border: none;
    background: transparent;
    font-size: 1.2rem;
    cursor: pointer;
    color: #999;
    display: none;
  }

  .search-clear-btn.visible {
    display: block;
  }

  .brand-card {
    padding: 15px;
    border: 1px solid #eee;
    border-radius: 10px;
    margin-bottom: 15px;
    transition: 0.3s ease;
    background: #fff;
  }

  .brand-card:hover {
    box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    transform: translateY(-2px);
  }

  .brand-image {
    width: 100px;
    height: auto;
    border-radius: 5px;
    object-fit: contain;
    border: 1px solid #ddd;
    padding: 5px;
    background: #fafafa;
  }

  .content-title {
    font-weight: 600;
    color: #333;
  }
</style>

<body>
  <div class="screen-overlay"></div>
  <%- include('./partials/sidebar') %>
  <main class="main-wrap">
    <%- include('./partials/header') %>
    <section class="content-main">
      
      <!-- Page Header -->
      <div class="content-header d-flex justify-content-between align-items-center mb-3">
        <div>
          <h2 class="content-title">Brand List</h2>
          <p class="text-muted">Manage all your saree brands here</p>
        </div>
        <div>
          <a href="/admin/brands/add" class="btn btn-primary">
            <i class="bi bi-plus-circle me-1"></i> Add Brand
          </a>
        </div>
      </div>

      <!-- Search Box -->
      <div class="card mb-4">
        <header class="card-header">
          <form action="/admin/brands" method="GET" class="d-flex gap-2">
            <div class="search-input-wrapper flex-grow-1">
              <input type="text" name="search" id="searchInput" 
                class="form-control"
                placeholder="Search by brand name..."
                value="<%= search %>" 
                oninput="toggleClearButton()" />
              <button type="button" class="search-clear-btn" id="clearSearchBtn" onclick="clearSearch()">Ã—</button>
            </div>
            <button type="submit" class="btn btn-outline-secondary">Search</button>
          </form>
        </header>

        <div class="card-body">
          <% if (brands.length === 0) { %>
            <p class="text-muted text-center">No brands found.</p>
          <% } %>

          <!-- Brand List -->
          <% brands.forEach(brand => { %>
            <article class="brand-card">
              <div class="row align-items-center">
                
                <!-- Brand Info -->
                <div class="col-lg-4 col-md-6 col-sm-12">
                  <h6 class="mb-1"><%= brand.name %></h6>
                  <small>Status: 
                      <span class="badge <%= brand.isBlocked ? 'bg-danger' : 'bg-success' %>">
                        <%= brand.isBlocked ? 'Blocked' : 'Active' %>
                      </span>
                    </small><br/>
                  <small class="text-muted">Created: <%= brand.createdAt.toDateString() %></small>
                </div>

                <!-- Brand Image -->
                <div class="col-lg-4 col-md-6 col-sm-12 text-center">
                  <img src="<%= brand.image %>" alt="brand image" class="brand-image" />
                </div>

                <!-- Actions -->
               
                    
                  

                <div class="col-lg-4 col-sm-12 text-end mt-2 mt-lg-0">
                  <% if (brand.isBlocked) { %>
                      <button type="button" class="btn btn-success" onclick="toggleBlock('<%= brand._id %>', false)">
                        <i class="material-icons md-lock_open"></i> Unblock
                      </button>
                      <% } else { %>
                        <button type="button" class="btn btn-danger" onclick="toggleBlock('<%= brand._id %>', true)">
                          <i class="material-icons md-lock"></i> Block
                        </button>
                        <% } %>
                  <a href="/admin/brands/edit/<%= brand._id %>" class="btn btn-sm btn-warning me-2">
                    <i class="bi bi-pencil-square"></i> Edit
                  </a>
                  <button class="btn btn-sm btn-danger delete-brand-btn" data-brand-id="<%= brand._id %>">
                    <i class="bi bi-trash"></i> Delete
                  </button>
                </div>
              </div>
            </article>
          <% }) %>

          <!-- Pagination -->
          <% if (totalPages > 1) { %>
            <nav class="mt-3">
              <ul class="pagination justify-content-center">
                <% for (let i = 1; i <= totalPages; i++) { %>
                  <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                    <a class="page-link" href="?page=<%= i %>&search=<%= search %>"><%= i %></a>
                  </li>
                <% } %>
              </ul>
            </nav>
          <% } %>
        </div>
      </div>
    </section>
    <%- include('./partials/footer') %>
  </main>

  
  <script>
    function toggleClearButton() {
      const input = document.getElementById('searchInput');
      const clearBtn = document.getElementById('clearSearchBtn');
      clearBtn.classList.toggle('visible', input.value.trim().length > 0);
    }

    function clearSearch() {
      const input = document.getElementById('searchInput');
      input.value = '';
      document.querySelector('form').submit();
    }
    toggleClearButton();
  </script>

  <!-- Vendor Scripts -->
  <script src="/admin/assets/js/vendors/jquery-3.6.0.min.js"></script>
  <script src="/admin/assets/js/bootstrap.bundle.min.js"></script>
  <script src="/admin/assets/js/main.js"></script>

  <!-- SweetAlert Delete -->
  <script>
    async function toggleBlock(brandId, block) {
  try {
    const res = await fetch(`/admin/brands/toggle/${brandId}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ isBlocked: block })
    });
    const data = await res.json();

    if (!res.ok) {
      Swal.fire({ icon: "error", title: "Error", text: data.message || "Something went wrong" });
      return;
    }

    Swal.fire({ icon: "success", title: block ? "Blocked" : "Unblocked", text: data.message })
      .then(() => window.location.reload());
  } catch (err) {
    Swal.fire({ icon: "error", title: "Error", text: "Server error: " + err });
  }
}
    document.querySelectorAll('.delete-brand-btn').forEach(button => {
      button.addEventListener('click', async () => {
        const brandId = button.getAttribute('data-brand-id');

        const result = await Swal.fire({
          title: `Are you sure?`,
          text: `You are about to delete this brand.`,
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#d33',
          cancelButtonColor: '#aaa',
          confirmButtonText: `Yes, delete it!`
        });

        if (result.isConfirmed) {
          try {
            const res = await fetch(`/admin/brands/delete/${brandId}`, { method: 'DELETE' }); 
            const data = await res.json();

            if (data.success) {
              Swal.fire({
                icon: 'success',
                title: `Brand deleted successfully`,
                showConfirmButton: false,
                timer: 1500
              }).then(() => location.reload());
            } else {
              Swal.fire('Error', data.message || 'Failed to delete', 'error');
            }
          } catch (err) {
            Swal.fire('Error', 'Something went wrong', 'error');
          }
        }
      });
    });
    
  </script>
</body>
</html>
