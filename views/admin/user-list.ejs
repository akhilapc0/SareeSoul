<!DOCTYPE html>
<html lang="en">
<%- include('./partials/head') %>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
  .search-input-wrapper {
    position: relative;
    width: 100%;
  }

  .search-clear-btn {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    border: none;
    background: transparent;
    font-size: 1.2rem;
    cursor: pointer;
    color: #999;
    display: none;
  }

  .search-clear-btn.visible {
    display: block;
  }
</style>

<body>
  <div class="screen-overlay"></div>
  <%- include('./partials/sidebar') %>
  <main class="main-wrap">
    <%- include('./partials/header') %>
    <section class="content-main">
      <div class="content-header">
        <div>
          <h2 class="content-title card-title">Users List</h2>
          <p>List of all registered users</p>
        </div>
      </div>
      <div class="card mb-4">
        <header class="card-header">
          <div class="row align-items-center">
            <div class="col-md-6 col-12">
              <form action="/admin/users" method="GET" class="d-flex gap-2">
                <!-- Search Input with Clear Button -->
                <div class="search-input-wrapper flex-grow-1">
                  <input type="text" name="search" id="searchInput" class="form-control"
                    placeholder="Search by name or email..." value="<%= search %>"
                    oninput="toggleClearButton()" />
                  <button type="button" class="search-clear-btn" id="clearSearchBtn"
                    onclick="clearSearch()">Ã—</button>
                </div>

                <!-- Status Dropdown -->
                <div class="flex-shrink-0">
                  <select name="status" class="form-select" onchange="this.form.submit()">
                    <option value="">All</option>
                    <option value="active" <%=status==='active' ? 'selected' : '' %>>Active</option>
                    <option value="blocked" <%=status==='blocked' ? 'selected' : '' %>>Blocked</option>
                  </select>
                </div>
              </form>
            </div>
          </div>
        </header>

        <div class="card-body">
          <% if (users.length === 0) { %>
            <p>No users found.</p>
          <% } %>

          <% users.forEach(user => { %>
            <article class="itemlist">
              <div class="row align-items-center">
                <div class="col col-check flex-grow-0">
                 
                </div>
                <div class="col-lg-4 col-sm-4 col-8 flex-grow-1 col-name">
                  <a class="itemside" href="#">
                    
                    <div class="info">
                      <h6 class="mb-0">
                        <%= user.firstName %> <%= user.lastName %>
                      </h6>
                      <small><%= user.email %></small>
                    </div>
                  </a>
                </div>
                <div class="col-lg-2 col-sm-2 col-4 col-price">
                  <span><%= user.phoneNumber %></span>
                </div>
                <div class="col-lg-2 col-sm-2 col-4 col-status">
                  <% if(user.isBlocked) { %>
                    <span class="badge rounded-pill alert-danger">Blocked</span>
                  <% } else { %>
                    <span class="badge rounded-pill alert-success">Active</span>
                  <% } %>
                </div>
                <div class="col-lg-2 col-sm-2 col-4 col-action text-end">
                  <button class="btn btn-sm toggle-block-btn <%= user.isBlocked ? 'btn-success' : 'btn-warning' %>"
                    data-user-id="<%= user._id %>">
                    <%= user.isBlocked ? 'Unblock' : 'Block' %>
                  </button>
                </div>
              </div>
            </article>
          <% }) %>

          <!-- Pagination -->
          <nav>
            <ul class="pagination justify-content-center">
              <% if (currentPage > 1) { %>
                <li class="page-item mx-1">
                  <a class="page-link"
                    href="?page=<%= currentPage - 1 %>&search=<%= search %>&status=<%= status %>">&laquo;</a>
                </li>
              <% } %>

              <% if (currentPage > 3) { %>
                <li class="page-item mx-1">
                  <a class="page-link" href="?page=1&search=<%= search %>&status=<%= status %>">1</a>
                </li>
                <% if (currentPage > 4) { %>
                  <li class="page-item mx-1 disabled">
                    <span class="page-link">...</span>
                  </li>
                <% } %>
              <% } %>

              <% for (let i = currentPage - 2; i <= currentPage + 2; i++) {
                if (i > 0 && i <= totalPages) { %>
                  <li class="page-item mx-1 <%= i === currentPage ? 'active' : '' %>">
                    <a class="page-link"
                      href="?page=<%= i %>&search=<%= search %>&status=<%= status %>"><%= i %></a>
                  </li>
              <% }} %>

              <% if (currentPage < totalPages - 2) { %>
                <% if (currentPage < totalPages - 3) { %>
                  <li class="page-item mx-1 disabled">
                    <span class="page-link">...</span>
                  </li>
                <% } %>
                <li class="page-item mx-1">
                  <a class="page-link"
                    href="?page=<%= totalPages %>&search=<%= search %>&status=<%= status %>">
                    <%= totalPages %>
                  </a>
                </li>
              <% } %>

              <% if (currentPage < totalPages) { %>
                <li class="page-item mx-1">
                  <a class="page-link"
                    href="?page=<%= currentPage + 1 %>&search=<%= search %>&status=<%= status %>">&raquo;</a>
                </li>
              <% } %>
            </ul>
          </nav>
        </div>
      </div>
    </section>
    <%- include('./partials/footer') %>
  </main>

  <script>
    function toggleClearButton() {
      const input = document.getElementById('searchInput');
      const clearBtn = document.getElementById('clearSearchBtn');
      clearBtn.classList.toggle('visible', input.value.trim().length > 0);
    }

    function clearSearch() {
      const input = document.getElementById('searchInput');
      input.value = '';
      document.querySelector('form').submit();
    }

    toggleClearButton(); // Initial call on page load
  </script>

  <script src="/admin/assets/js/vendors/jquery-3.6.0.min.js"></script>
  <script src="/admin/assets/js/bootstrap.bundle.min.js"></script>
  <script src="/admin/assets/js/main.js" type="text/javascript"></script>

  <script>
    document.querySelectorAll('.toggle-block-btn').forEach(button => {
      button.addEventListener('click', async () => {
        const userId = button.getAttribute('data-user-id');
        const action = button.textContent.trim();

        const result = await Swal.fire({
          title: `Are you sure?`,
          text: `You are about to ${action.toLowerCase()} this user.`,
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#3085d6',
          cancelButtonColor: '#d33',
          confirmButtonText: `Yes, ${action}!`
        });

        if (result.isConfirmed) {
          try {
            const res = await fetch(`/admin/users/${userId}/toggle-block`, {
              method: 'POST'
            });
            const data = await res.json();

            if (data.success) {
              Swal.fire({
                icon: 'success',
                title: `User ${data.isBlocked ? 'blocked' : 'unblocked'} successfully`,
                showConfirmButton: false,
                timer: 1500
              }).then(() => {
                location.reload();
              });
            } else {
              Swal.fire('Error', data.message || 'Failed to update user status', 'error');
            }
          } catch (error) {
            console.error('Error:', error);
            Swal.fire('Error', 'Something went wrong', 'error');
          }
        }
      });
    });
  </script>
</body>

</html>
