<!DOCTYPE html>
<html lang="en">
<%- include('./partials/head') %>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  .stat-card {
    border-radius: 10px;
    padding: 20px;
    color: white;
    margin-bottom: 20px;
  }
  
  .stat-card.revenue {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  }
  
  .stat-card.customers {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
  }
  
  .stat-card.orders {
    background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
  }
  
  .stat-value {
    font-size: 2rem;
    font-weight: bold;
    margin: 10px 0;
  }
  
  .stat-change {
    font-size: 0.9rem;
    display: flex;
    align-items: center;
    gap: 5px;
  }
  
  .stat-change.positive {
    color: #a8ff78;
  }
  
  .stat-change.negative {
    color: #ff6b6b;
  }
  
  .chart-container {
    position: relative;
    height: 300px;
    margin-bottom: 30px;
  }
  
  .filter-dropdown {
    min-width: 150px;
  }
  
  .table-img {
    width: 40px;
    height: 40px;
    object-fit: cover;
    border-radius: 5px;
  }
</style>

<body>
  <div class="screen-overlay"></div>
  <%- include('./partials/sidebar') %>
  
  <main class="main-wrap">
    <%- include('./partials/header') %>
    
    <section class="content-main">
      <div class="content-header">
        <div>
          <h2 class="content-title">Dashboard</h2>
          <p>Overview of your store performance</p>
        </div>
        <div>
          <form action="/admin/dashboard" method="GET">
            <select name="filter" class="form-select filter-dropdown" onchange="this.form.submit()">
              <option value="daily" <%= (typeof filter !== 'undefined' && filter === 'daily') ? 'selected' : '' %>>Daily</option>
              <option value="weekly" <%= (typeof filter === 'undefined' || filter === 'weekly') ? 'selected' : '' %>>Weekly</option>
              <option value="monthly" <%= (typeof filter !== 'undefined' && filter === 'monthly') ? 'selected' : '' %>>Monthly</option>
              <option value="yearly" <%= (typeof filter !== 'undefined' && filter === 'yearly') ? 'selected' : '' %>>Yearly</option>
            </select>
          </form>
        </div>
      </div>

      <!-- Statistics Cards -->
      <div class="row">
        <div class="col-lg-4">
          <div class="stat-card revenue">
            <div>
              <i class="fas fa-chart-line fa-2x"></i>
              <h6>Total Revenue</h6>
            </div>
            <div class="stat-value">₹<%= totalRevenue.toLocaleString('en-IN') %></div>
            <div class="stat-change <%= revenueChange >= 0 ? 'positive' : 'negative' %>">
              <i class="fas fa-arrow-<%= revenueChange >= 0 ? 'up' : 'down' %>"></i>
              <%= Math.abs(revenueChange) %>%
            </div>
          </div>
        </div>
        
        <div class="col-lg-4">
          <div class="stat-card customers">
            <div>
              <i class="fas fa-users fa-2x"></i>
              <h6>Total Customers</h6>
            </div>
            <div class="stat-value"><%= totalCustomers %></div>
            <div class="stat-change <%= customerChange >= 0 ? 'positive' : 'negative' %>">
              <i class="fas fa-arrow-<%= customerChange >= 0 ? 'up' : 'down' %>"></i>
              <%= Math.abs(customerChange) %>%
            </div>
          </div>
        </div>
        
        <div class="col-lg-4">
          <div class="stat-card orders">
            <div>
              <i class="fas fa-shopping-cart fa-2x"></i>
              <h6>Total Orders</h6>
            </div>
            <div class="stat-value"><%= totalOrders %></div>
            <div class="stat-change <%= orderChange >= 0 ? 'positive' : 'negative' %>">
              <i class="fas fa-arrow-<%= orderChange >= 0 ? 'up' : 'down' %>"></i>
              <%= Math.abs(orderChange) %>%
            </div>
          </div>
        </div>
      </div>

      <!-- Charts Row -->
      <div class="row">
        <!-- Sales Revenue Chart -->
        <div class="col-lg-8">
          <div class="card mb-4">
            <div class="card-header">
              <h5>Sales Revenue</h5>
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="salesChart"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- Category Performance Pie Chart -->
        <div class="col-lg-4">
          <div class="card mb-4">
            <div class="card-header">
              <h5>Category Performance</h5>
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="categoryChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Additional Charts -->
      <div class="row">
        <!-- Customer Growth -->
        <div class="col-lg-6">
          <div class="card mb-4">
            <div class="card-header">
              <h5>Customer Growth</h5>
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="customerChart"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- Orders Overview -->
        <div class="col-lg-6">
          <div class="card mb-4">
            <div class="card-header">
              <h5>Orders Overview</h5>
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="ordersChart"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Top 10 Best Selling Products -->
      <div class="card mb-4">
        <div class="card-header">
          <h5>Top 10 Best Selling Products</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Rank</th>
                  <th>Image</th>
                  <th>Product Name</th>
                  <th>Sold</th>
                  <th>Revenue</th>
                </tr>
              </thead>
              <tbody>
                <% topProducts.forEach((product, index) => { %>
                  <tr>
                    <td><%= index + 1 %></td>
                    <td>
                      <% if (product.image && product.image[0]) { %>
                        <img src="<%= product.image[0] %>" alt="Product" class="table-img">
                      <% } else { %>
                        <div class="table-img bg-secondary"></div>
                      <% } %>
                    </td>
                    <td><%= product.name %></td>
                    <td><%= product.sold %></td>
                    <td>₹<%= product.revenue.toLocaleString('en-IN') %></td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Top 10 Best Selling Categories -->
      <div class="card mb-4">
        <div class="card-header">
          <h5>Top 10 Best Selling Categories</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Rank</th>
                  <th>Category Name</th>
                  <th>Sold</th>
                  <th>Revenue</th>
                </tr>
              </thead>
              <tbody>
                <% topCategories.forEach((category, index) => { %>
                  <tr>
                    <td><%= index + 1 %></td>
                    <td><%= category.name %></td>
                    <td><%= category.sold %></td>
                    <td>₹<%= category.revenue.toLocaleString('en-IN') %></td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Top 10 Best Selling Brands -->
      <div class="card mb-4">
        <div class="card-header">
          <h5>Top 10 Best Selling Brands</h5>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Rank</th>
                  <th>Image</th>
                  <th>Brand Name</th>
                  <th>Sold</th>
                  <th>Revenue</th>
                </tr>
              </thead>
              <tbody>
                <% topBrands.forEach((brand, index) => { %>
                  <tr>
                    <td><%= index + 1 %></td>
                    <td>
                      <% if (brand.image) { %>
                        <img src="<%= brand.image %>" alt="Brand" class="table-img">
                      <% } else { %>
                        <div class="table-img bg-secondary"></div>
                      <% } %>
                    </td>
                    <td><%= brand.name %></td>
                    <td><%= brand.sold %></td>
                    <td>₹<%= brand.revenue.toLocaleString('en-IN') %></td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Recent Orders -->
      <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5>Recent Orders</h5>
          <a href="/admin/orders" class="btn btn-sm btn-primary">View All</a>
        </div>
        <div class="card-body">
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>Order ID</th>
                  <th>Customer</th>
                  <th>Date</th>
                  <th>Amount</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody>
                <% recentOrders.forEach(order => { %>
                  <tr>
                    <td><%= order.orderId %></td>
                    <td><%= order.userId ? `${order.userId.firstName} ${order.userId.lastName}` : 'N/A' %></td>
                    <td><%= new Date(order.createdAt).toLocaleDateString() %></td>
                    <td>₹<%= order.total.toLocaleString('en-IN') %></td>
                    <td>
                      <span class="badge bg-<%= 
                        order.status === 'Delivered' ? 'success' : 
                        order.status === 'Cancelled' ? 'danger' : 
                        order.status === 'Shipped' ? 'info' : 'warning' 
                      %>">
                        <%= order.status %>
                      </span>
                    </td>
                  </tr>
                <% }); %>
              </tbody>
            </table>
          </div>
        </div>
      </div>

    </section>
    <%- include('./partials/footer') %>
  </main>

  <script>
    // Parse data from server
    const salesData = JSON.parse('<%- salesChartData %>');
    const customerData = JSON.parse('<%- customerChartData %>');
    const ordersData = JSON.parse('<%- ordersChartData %>');
    const categoryData = JSON.parse('<%- categoryPerformance %>');

    // Sales Revenue Chart
    new Chart(document.getElementById('salesChart'), {
      type: 'line',
      data: {
        labels: salesData.map(d => d._id),
        datasets: [{
          label: 'Sales Revenue (₹)',
          data: salesData.map(d => d.revenue),
          borderColor: '#667eea',
          backgroundColor: 'rgba(102, 126, 234, 0.1)',
          fill: true,
          tension: 0.4
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: true }
        },
        scales: {
          y: { beginAtZero: true }
        }
      }
    });

    // Customer Growth Chart
    new Chart(document.getElementById('customerChart'), {
      type: 'bar',
      data: {
        labels: customerData.map(d => d._id),
        datasets: [{
          label: 'New Customers',
          data: customerData.map(d => d.count),
          backgroundColor: '#f5576c'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: true }
        },
        scales: {
          y: { beginAtZero: true }
        }
      }
    });

    // Orders Overview Chart
    new Chart(document.getElementById('ordersChart'), {
      type: 'bar',
      data: {
        labels: ordersData.map(d => d._id),
        datasets: [{
          label: 'Orders',
          data: ordersData.map(d => d.count),
          backgroundColor: '#00f2fe'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: true }
        },
        scales: {
          y: { beginAtZero: true }
        }
      }
    });

    // Category Performance Pie Chart
    new Chart(document.getElementById('categoryChart'), {
      type: 'doughnut',
      data: {
        labels: categoryData.map(d => d.name),
        datasets: [{
          data: categoryData.map(d => d.value),
          backgroundColor: [
            '#667eea',
            '#f5576c',
            '#4facfe',
            '#43e97b',
            '#fa709a',
            '#fee140',
            '#30cfd0',
            '#a8edea',
            '#ff6b6b',
            '#c471ed'
          ]
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { 
            position: 'bottom',
            labels: { boxWidth: 12 }
          }
        }
      }
    });
  </script>
  
<script src="/admin/assets/js/vendors/jquery-3.6.0.min.js"></script>
  <script src="/admin/assets/js/vendors/bootstrap.bundle.min.js"></script>
  <script src="/admin/assets/js/main.js"></script> 
</body>
</html>