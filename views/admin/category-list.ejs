<!DOCTYPE html>
<html lang="en">
<%- include('./partials/head') %>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    .search-input-wrapper {
      position: relative;
      width: 100%;
    }

    .search-clear-btn {
      position: absolute;
      right: 10px;
      top: 50%;
      transform: translateY(-50%);
      border: none;
      background: transparent;
      font-size: 1.2rem;
      cursor: pointer;
      color: #999;
      display: none;
    }

    .search-clear-btn.visible {
      display: block;
    }

    .fixed-width-btn {
      min-width: 100px;
      text-align: center;
    }

    /* Offer badge styling */
    .offer-badge {
      display: inline-block;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
      font-weight: bold;
      margin-left: 8px;
    }

    .offer-info {
      font-size: 0.85rem;
      color: #666;
      margin-top: 4px;
    }

    .action-buttons {
      display: flex;
      gap: 5px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .action-buttons .btn {
      font-size: 0.8rem;
      padding: 0.375rem 0.75rem;
      white-space: nowrap;
    }

    @media (max-width: 768px) {
      .action-buttons {
        flex-direction: column;
        width: 100%;
      }
      
      .action-buttons .btn {
        width: 100%;
        margin-bottom: 2px;
      }
    }
  </style>

  <body>
    <div class="screen-overlay"></div>
    <%- include('./partials/sidebar') %>
      <main class="main-wrap">
        <%- include('./partials/header') %>
          <section class="content-main">
            <div class="content-header">
              <div>
                <h2 class="content-title card-title">Category List</h2>
                <p>Manage your saree categories</p>
              </div>
              <div>
                <a href="/admin/categories/add" class="btn btn-primary">Add Category</a>
              </div>
            </div>

            <div class="card mb-4">
              <header class="card-header">
                <form action="/admin/categories" method="GET" class="d-flex gap-2">
                  <div class="search-input-wrapper flex-grow-1">
                    <input type="text" name="search" id="searchInput" class="form-control"
                      placeholder="Search by category name..." value="<%= search %>" oninput="toggleClearButton()" />
                    <button type="button" class="search-clear-btn" id="clearSearchBtn"
                      onclick="clearSearch()">Ã—</button>
                  </div>
                </form>
              </header>

              <div class="card-body">
                <% if (categories.length===0) { %>
                  <p>No categories found.</p>
                  <% } %>

                    <% categories.forEach(category=> { %>
                      <article class="itemlist">
                        <div class="row align-items-center">
                          <div class="col-lg-6 col-sm-6 col-8 flex-grow-1 col-name">
                            <div class="info">
                              <h6 class="mb-0">
                                <%= category.name %>
                                <!-- Show offer badge if category has an active offer -->
                                <% if (category.offer && category.offer.discountPercentage) { %>
                                  <span class="offer-badge"><%= category.offer.discountPercentage %>% OFF</span>
                                <% } %>
                              </h6>

                              <!-- Show offer dates if active -->
                              <% if (category.offer && category.offer.discountPercentage) { %>
                                <div class="offer-info">
                                  <small>
                                    <i class="material-icons md-local_offer" style="font-size: 14px;"></i>
                                    Offer: <%= new Date(category.offer.startDate).toLocaleDateString() %> to 
                                    <%= new Date(category.offer.endDate).toLocaleDateString() %>
                                  </small>
                                </div>
                              <% } %>

                              <small>Status:
                                <span class="badge <%= category.isBlocked ? 'bg-danger' : 'bg-success' %>">
                                  <%= category.isBlocked ? 'Blocked' : 'Active' %>
                                </span>
                              </small><br />
                              <small>Created: <%= category.createdAt.toDateString() %></small>
                            </div>
                          </div>

                          <div class="col-lg-6 col-sm-6 col-4 col-action text-end">
                            <div class="action-buttons">

                              <!-- Offer Management Buttons -->
                              <% if (category.offer && category.offer.discountPercentage) { %>
                                <!-- Category has an offer - show Remove button -->
                                <button class="btn btn-sm btn-secondary" onclick="removeCategoryOffer('<%= category._id %>')">
                                  Remove Offer
                                </button>
                              <% } else { %>
                                <!-- No offer - show Add button -->
                                <button class="btn btn-sm btn-primary" onclick="addCategoryOffer('<%= category._id %>')">
                                  Add Offer
                                </button>
                              <% } %>

                              <% if (category.isBlocked) { %>
                                <button type="button" class="btn btn-success fixed-width-btn"
                                  onclick="toggleBlock('<%= category._id %>', false)">
                                  Unblock
                                </button>
                              <% } else { %>
                                <button type="button" class="btn btn-danger fixed-width-btn"
                                  onclick="toggleBlock('<%= category._id %>', true)">
                                  Block
                                </button>
                              <% } %>

                              <a href="/admin/categories/edit/<%= category._id %>"
                                class="btn btn-sm btn-warning fixed-width-btn">Edit</a>
                              
                              <button class="btn btn-sm btn-danger fixed-width-btn delete-category-btn"
                                data-category-id="<%= category._id %>">
                                Delete
                              </button>
                            </div>
                          </div>

                        </div>
                      </article>
                      <% }) %>


                        <!-- Pagination -->
                        <% if (totalPages> 1) { %>
                          <nav>
                            <ul class="pagination justify-content-center">
                              <% for (let i=1; i <=totalPages; i++) { %>
                                <li class="page-item  <%= i === currentPage ? 'active' : '' %>">
                                  <a class="page-link" href="?page=<%= i %>&search=<%= search %>">
                                    <%= i %>
                                  </a>
                                </li>
                                <% } %>
                            </ul>
                          </nav>
                          <% } %>
              </div>
            </div>
          </section>
          <%- include('./partials/footer') %>
      </main>

      <script>
        function toggleClearButton() {
          const input = document.getElementById('searchInput');
          const clearBtn = document.getElementById('clearSearchBtn');
          clearBtn.classList.toggle('visible', input.value.trim().length > 0);
        }

        function clearSearch() {
          const input = document.getElementById('searchInput');
          input.value = '';
          document.querySelector('form').submit();
        }

        toggleClearButton();

        // ========================================
        // CATEGORY OFFER MANAGEMENT FUNCTIONS
        // ========================================

        // Add Category Offer
        async function addCategoryOffer(categoryId) {
          const { value: formValues } = await Swal.fire({
            title: 'Add Category Offer',
            html: `
              <div style="text-align: left;">
                <label style="display: block; margin-bottom: 5px; font-weight: 600;">Discount Percentage (%)</label>
                <input id="discount" type="number" min="1" max="100" class="swal2-input" placeholder="Enter discount %" style="width: 90%;">
                
                <label style="display: block; margin-top: 15px; margin-bottom: 5px; font-weight: 600;">Start Date</label>
                <input id="startDate" type="date" class="swal2-input" style="width: 90%;">
                
                <label style="display: block; margin-top: 15px; margin-bottom: 5px; font-weight: 600;">End Date</label>
                <input id="endDate" type="date" class="swal2-input" style="width: 90%;">
              </div>
            `,
            focusConfirm: false,
            showCancelButton: true,
            confirmButtonText: 'Add Offer',
            confirmButtonColor: '#28a745',
            cancelButtonColor: '#6c757d',
            preConfirm: () => {
              const discount = document.getElementById('discount').value;
              const startDate = document.getElementById('startDate').value;
              const endDate = document.getElementById('endDate').value;

              if (!discount || !startDate || !endDate) {
                Swal.showValidationMessage('All fields are required!');
                return false;
              }

              if (discount < 1 || discount > 100) {
                Swal.showValidationMessage('Discount must be between 1-100%');
                return false;
              }

              if (new Date(startDate) >= new Date(endDate)) {
                Swal.showValidationMessage('End date must be after start date');
                return false;
              }

              return { discount, startDate, endDate };
            }
          });

          if (formValues) {
            try {
              const res = await fetch(`/admin/offer/category/add-offer/${categoryId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  discountPercentage: formValues.discount,
                  startDate: formValues.startDate,
                  endDate: formValues.endDate
                })
              });

              const data = await res.json();

              if (data.success) {
                Swal.fire({
                  icon: 'success',
                  title: 'Category Offer Added!',
                  text: data.message,
                  timer: 1500,
                  showConfirmButton: false
                }).then(() => location.reload());
              } else {
                Swal.fire('Error', data.message, 'error');
              }
            } catch (err) {
              Swal.fire('Error', 'Server error: ' + err, 'error');
            }
          }
        }

        // Remove Category Offer
        async function removeCategoryOffer(categoryId) {
          const result = await Swal.fire({
            title: 'Remove Category Offer?',
            text: 'This will affect all products in this category!',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#d33',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Yes, remove it!'
          });

          if (result.isConfirmed) {
            try {
              const res = await fetch(`/admin/offer/category/remove-offer/${categoryId}`, {
                method: 'DELETE'
              });

              const data = await res.json();

              if (data.success) {
                Swal.fire({
                  icon: 'success',
                  title: 'Category Offer Removed!',
                  text: data.message,
                  timer: 1500,
                  showConfirmButton: false
                }).then(() => location.reload());
              } else {
                Swal.fire('Error', data.message, 'error');
              }
            } catch (err) {
              Swal.fire('Error', 'Server error: ' + err, 'error');
            }
          }
        }

        // Toggle Block/Unblock
        async function toggleBlock(categoryId, block) {
          try {
            const res = await fetch(`/admin/categories/toggle/${categoryId}`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ isBlocked: block })
            });
            const data = await res.json();

            if (!res.ok) {
              Swal.fire({ icon: "error", title: "Error", text: data.message || "Something went wrong" });
              return;
            }

            Swal.fire({ icon: "success", title: block ? "Blocked" : "Unblocked", text: data.message })
              .then(() => window.location.reload());
          } catch (err) {
            Swal.fire({ icon: "error", title: "Error", text: "Server error: " + err });
          }
        }
      </script>

      <script src="/admin/assets/js/vendors/jquery-3.6.0.min.js"></script>
      <script src="/admin/assets/js/bootstrap.bundle.min.js"></script>
      <script src="/admin/assets/js/main.js"></script>

      <!-- SweetAlert Delete -->
      <script>
        document.querySelectorAll('.delete-category-btn').forEach(button => {
          button.addEventListener('click', async () => {
            const categoryId = button.getAttribute('data-category-id');

            const result = await Swal.fire({
              title: `Are you sure?`,
              text: `You are about to delete this category.`,
              icon: 'warning',
              showCancelButton: true,
              confirmButtonColor: '#d33',
              cancelButtonColor: '#aaa',
              confirmButtonText: `Yes, delete it!`
            });

            if (result.isConfirmed) {
              try {
                const res = await fetch(`/admin/categories/delete/${categoryId}`, {
                  method: 'DELETE'
                });

                const data = await res.json();

                if (data.success) {
                  Swal.fire({
                    icon: 'success',
                    title: `Category deleted successfully`,
                    showConfirmButton: false,
                    timer: 1500
                  }).then(() => location.reload());
                } else {
                  Swal.fire('Error', data.message || 'Failed to delete', 'error');
                }
              } catch (err) {
                Swal.fire('Error', 'Something went wrong', 'error');
              }
            }
          });
        });
      </script>
  </body>

</html>