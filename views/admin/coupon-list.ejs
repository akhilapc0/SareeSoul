<!DOCTYPE html>
<html lang="en">
<%- include('./partials/head') %>

<style>
  .coupon-card {
    background: white;
    border-radius: 10px;
    padding: 20px;
    box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    margin-bottom: 20px;
  }

  .coupon-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 15px;
  }

  .coupon-code {
    font-size: 1.5rem;
    font-weight: bold;
    color: #008B8B;
  }

  .coupon-details {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 15px;
    margin-bottom: 15px;
  }

  .detail-item {
    display: flex;
    flex-direction: column;
  }

  .detail-label {
    font-size: 0.85rem;
    color: #666;
    margin-bottom: 5px;
  }

  .detail-value {
    font-size: 1rem;
    font-weight: 600;
    color: #333;
  }

  .badge {
    padding: 5px 12px;
    border-radius: 20px;
    font-size: 0.85rem;
    font-weight: 600;
  }

  .badge-active {
    background: #28a745;
    color: white;
  }

  .badge-blocked {
    background: #dc3545;
    color: white;
  }

  .badge-expired {
    background: #6c757d;
    color: white;
  }

  .usage-bar {
    width: 100%;
    height: 8px;
    background: #e0e0e0;
    border-radius: 4px;
    overflow: hidden;
    margin-top: 5px;
  }

  .usage-fill {
    height: 100%;
    background: linear-gradient(90deg, #008B8B, #006B6B);
    transition: width 0.3s ease;
  }

  .btn-toggle {
    padding: 8px 16px;
    border: none;
    border-radius: 5px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s;
  }

  .btn-block {
    background: #dc3545;
    color: white;
  }

  .btn-unblock {
    background: #28a745;
    color: white;
  }

  .btn-toggle:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
  }

  .add-coupon-btn {
    background: linear-gradient(135deg, #008B8B, #006B6B);
    color: white;
    padding: 12px 24px;
    border: none;
    border-radius: 8px;
    font-weight: 600;
    text-decoration: none;
    display: inline-block;
    transition: all 0.3s;
  }

  .add-coupon-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 139, 139, 0.3);
    color: white;
  }
</style>

<body>
  <div class="screen-overlay"></div>
  <%- include('./partials/sidebar') %>
  
  <main class="main-wrap">
    <%- include('./partials/header') %>
    
    <script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <section class="content-main">
      <div class="content-header d-flex justify-content-between align-items-center mb-4">
        <div>
          <h2 class="content-title">Manage Coupons</h2>
          <p class="text-muted">Create and manage discount coupons</p>
        </div>
        <div>
          <a href="/admin/coupons/add" class="add-coupon-btn">
            <i class="bi bi-plus-circle me-1"></i> Add New Coupon
          </a>
        </div>
      </div>

      <% if (error) { %>
        <div class="alert alert-danger alert-dismissible fade show">
          <%= error %>
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      <% } %>

      <% if (success) { %>
        <div class="alert alert-success alert-dismissible fade show">
          <%= success %>
          <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
      <% } %>

      <% if (coupons.length === 0) { %>
        <div class="card">
          <div class="card-body text-center py-5">
            <i class="bi bi-ticket-perforated" style="font-size: 3rem; color: #ccc;"></i>
            <p class="text-muted mt-3 mb-0">No coupons found. Create your first coupon!</p>
          </div>
        </div>
      <% } else { %>
        <% coupons.forEach(coupon => { %>
          <% 
            const isExpired = new Date(coupon.validityDate) < new Date();
            const usagePercentage = (coupon.usedCount / coupon.usageLimit) * 100;
            let statusBadge = 'badge-active';
            let statusText = 'Active';
            
            if (isExpired) {
              statusBadge = 'badge-expired';
              statusText = 'Expired';
            } else if (!coupon.isActive) {
              statusBadge = 'badge-blocked';
              statusText = 'Blocked';
            }
          %>

          <div class="coupon-card">
            <div class="coupon-header">
              <div class="coupon-code"><%= coupon.code %></div>
              <span class="badge <%= statusBadge %>"><%= statusText %></span>
            </div>

            <div class="coupon-details">
              <div class="detail-item">
                <span class="detail-label">Discount</span>
                <span class="detail-value"><%= coupon.discountValue %>%</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Min Cart Amount</span>
                <span class="detail-value">₹<%= coupon.minCartAmount %></span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Max Discount</span>
                <span class="detail-value">₹<%= coupon.maxDiscount %></span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Validity</span>
                <span class="detail-value"><%= new Date(coupon.validityDate).toLocaleDateString('en-IN') %></span>
              </div>
            </div>

            <div class="detail-item">
              <span class="detail-label">Usage: <%= coupon.usedCount %> / <%= coupon.usageLimit %></span>
              <div class="usage-bar">
                <div class="usage-fill" style="width: <%= usagePercentage %>%"></div>
              </div>
            </div>

            <div class="mt-3">
              <% if (!isExpired) { %>
                <button 
                  class="btn-toggle <%= coupon.isActive ? 'btn-block' : 'btn-unblock' %>" 
                  onclick="toggleCoupon('<%= coupon._id %>', <%= coupon.isActive %>)"
                >
                  <%= coupon.isActive ? 'Block' : 'Unblock' %>
                </button>
              <% } %>
            </div>
          </div>
        <% }) %>
      <% } %>
    </section>

    <%- include('./partials/footer') %>
  </main>

  <script src="/admin/assets/js/vendors/jquery-3.6.0.min.js"></script>
  <script src="/admin/assets/js/vendors/bootstrap.bundle.min.js"></script>
  <script src="/admin/assets/js/main.js"></script>

  <script>
    async function toggleCoupon(couponId, currentStatus) {
 
      const action = currentStatus ? 'block' : 'unblock';
      
      const result = await Swal.fire({
        title: `${action.charAt(0).toUpperCase() + action.slice(1)} Coupon?`,
        text: `Are you sure you want to ${action} this coupon?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#008B8B',
        cancelButtonColor: '#d33',
        confirmButtonText: `Yes, ${action} it!`
      });

      if (result.isConfirmed) {
        try {
          const response = await fetch(`/admin/coupons/toggle/${couponId}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
          });

          const data = await response.json();

          if (data.success) {
            Swal.fire({
              icon: 'success',
              title: 'Success!',
              text: data.message,
              confirmButtonColor: '#008B8B'
            }).then(() => {
              window.location.reload();
            });
          } else {
            Swal.fire({
              icon: 'error',
              title: 'Error',
              text: data.message,
              confirmButtonColor: '#008B8B'
            });
          }
        } catch (error) {
          console.error('Error:', error);
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: 'Something went wrong!',
            confirmButtonColor: '#008B8B'
          });
        }
      }
    }
  </script>
</body>
</html>