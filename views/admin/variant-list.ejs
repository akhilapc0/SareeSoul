<!DOCTYPE html>
<html lang="en">
<%- include('./partials/head') %>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
  .search-input-wrapper {
    position: relative;
    width: 100%;
  }

  .search-clear-btn {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    border: none;
    background: transparent;
    font-size: 1.2rem;
    cursor: pointer;
    color: #999;
    display: none;
  }

  .search-clear-btn.visible {
    display: block;
  }

  .variant-img {
    width: 50px;
    height: 50px;
    object-fit: cover;
    border-radius: 6px;
  }

  .badge {
    padding: 4px 8px;
    border-radius: 12px;
    font-size: 12px;
  }

  .badge-success {
    background-color: #28a745;
    color: white;
  }

  .badge-danger {
    background-color: #dc3545;
    color: white;
  }
</style>

<body>
  <div class="screen-overlay"></div>
  <%- include('./partials/sidebar') %>
  <main class="main-wrap">
    <%- include('./partials/header') %>
    <section class="content-main">
      <div class="content-header">
        <div>
          <h2 class="content-title card-title">Variants of <%= product.name %></h2>
          <p>Manage product variants (colours, stock, images)</p>
        </div>
        <div>
          <a href="/admin/products/<%= product._id %>/variants/add" class="btn btn-primary">Add Variant</a>
        </div>
      </div>

      <div class="card mb-4">
        <header class="card-header">
          <form action="/admin/products/<%= product._id %>/variants" method="GET" class="d-flex gap-2">
            <div class="search-input-wrapper flex-grow-1">
              <input type="text" name="search" id="searchInput" class="form-control"
                placeholder="Search by colour..." value="<%= search %>" oninput="toggleClearButton()" />
              <button type="button" class="search-clear-btn" id="clearSearchBtn" onclick="clearSearch()">Ã—</button>
            </div>
          </form>
        </header>

        <div class="card-body">
          <% if (variants.length === 0) { %>
            <p>No variants found.</p>
          <% } %>

          <% variants.forEach(variant => { %>
            <article class="itemlist">
              <div class="row align-items-center">
                
                <!-- Variant info -->
                <div class="col-lg-6 col-sm-6 col-8 flex-grow-1 col-name">
                  <div class="info">
                    <h6 class="mb-0">Colour: <%= variant.colour %></h6>
                    <small>Stock: <%= variant.stock %></small><br/>
                    <small>Status: 
                      <span class="badge <%= variant.isBlocked ? 'badge-danger' : 'badge-success' %>">
                        <%= variant.isBlocked ? 'Blocked' : 'Active' %>
                      </span>
                    </small><br/>
                    <small>Created: <%= variant.createdAt.toDateString() %></small>
                  </div>
                </div>

                <!-- Variant image -->
                <div class="col-lg-2 col-sm-3 col-4">
                  <% if (variant.images && variant.images.length > 0) { %>
                    <img src="<%= variant.images[0] %>" alt="Variant Image" class="variant-img"/>
                  <% } else { %>
                    <span>No Image</span>
                  <% } %>
                </div>

                <!-- Actions -->
                <div class="col-lg-3 col-sm-3 col-12 col-action text-end">
                  <a href="/admin/products/<%= product._id %>/variants/edit/<%= variant._id %>" class="btn btn-sm btn-warning">Edit</a>

                  <% if (variant.isBlocked) { %>
                    <button class="btn btn-sm btn-success" onclick="toggleBlock('<%= variant._id %>', false)">Unblock</button>
                  <% } else { %>
                    <button class="btn btn-sm btn-danger" onclick="toggleBlock('<%= variant._id %>', true)">Block</button>
                  <% } %>

                  <button class="btn btn-sm btn-danger delete-product-btn" data-product-id="<%= product._id %>" data-variant-id="<%= variant._id %>">
                      Delete
                    </button>
                </div>

              </div>
            </article>
          <% }) %>

          <!-- Pagination -->
          <% if (totalPages > 1) { %>
            <nav>
              <ul class="pagination justify-content-center">
                <% for (let i = 1; i <= totalPages; i++) { %>
                  <li class="page-item <%= i === currentPage ? 'active' : '' %>">
                    <a class="page-link" href="?page=<%= i %>&search=<%= search %>"><%= i %></a>
                  </li>
                <% } %>
              </ul>
            </nav>
          <% } %>
        </div>
      </div>
    </section>
    <%- include('./partials/footer') %>
  </main>

  <script>
    function toggleClearButton() {
      const input = document.getElementById('searchInput');
      const clearBtn = document.getElementById('clearSearchBtn');
      clearBtn.classList.toggle('visible', input.value.trim().length > 0);
    }

    function clearSearch() {
      const input = document.getElementById('searchInput');
      input.value = '';
      document.querySelector('form').submit();
    }

    toggleClearButton();

    async function toggleBlock(variantId, block) {
      try {
        const res = await fetch(`/admin/products/<%= product._id %>/variants/block/${variantId}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ isBlocked: block })
        });

        const data = await res.json();

        if (!res.ok) {
          Swal.fire({ icon: "error", title: "Error", text: data.message || "Something went wrong" });
          return;
        }

        Swal.fire({
          icon: "success",
          title: block ? "Blocked" : "Unblocked",
          text: data.message
        }).then(() => location.reload());

      } catch (err) {
        Swal.fire({ icon: "error", title: "Error", text: "Server error: " + err });
      }
    }
  </script>
     <script>
    document.querySelectorAll('.delete-product-btn').forEach(button => {
      button.addEventListener('click', async () => {
        const variantId = button.getAttribute('data-variant-id');
        const productId=button.getAttribute('data-product-id')
        const result = await Swal.fire({
          title: 'Are you sure?',
          text: 'You are about to delete this variant.',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#d33',
          cancelButtonColor: '#aaa',
          confirmButtonText: 'Yes, delete it!'
        });

        if (result.isConfirmed) {
          try {
            const res = await fetch(`/admin/products/${productId}/variants/delete/${variantId}`, {
              method: 'DELETE'
            }); 

            const data = await res.json();

            if (data.success) {
              Swal.fire({
                icon: 'success',
                title: 'variant deleted successfully',
                showConfirmButton: false,
                timer: 1500
              }).then(() => location.reload());
            } else {
              Swal.fire('Error', data.message || 'Failed to delete variant', 'error');
            }
          } catch (err) {
            Swal.fire('Error', 'Something went wrong', 'error');
          }
        }
      });
    });
  </script>
  <script src="/admin/assets/js/vendors/jquery-3.6.0.min.js"></script>
  <script src="/admin/assets/js/vendors/bootstrap.bundle.min.js"></script>
  <script src="/admin/assets/js/main.js"></script>
</body>
</html>
